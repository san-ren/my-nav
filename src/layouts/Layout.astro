---
import { ClientRouter } from 'astro:transitions'; 
// ✅ 1. 引入全局样式和主题配置
import '../styles/global.css'; 
import '../styles/theme.css';  

const { title } = Astro.props;
const base = '/my-nav';
---

<!doctype html>
<html lang="zh-CN" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    
    <!-- ✅ 修改点：优化移动端视口设置，禁止用户缩放和自动缩放，防止布局抖动 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <link rel="icon" type="image/svg+xml" href={`${base}/favicon.svg`} />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    
    <!-- 启用 View Transitions -->
    <ClientRouter />
    
    <!-- ✅ 2. 升级版防闪烁脚本 (同时处理 DarkMode + AppTheme) -->
    <script is:inline>
      // 定义初始化函数：负责读取 LocalStorage 并应用样式
      const initAllThemes = () => {
        // --- A. 处理暗色模式 (Dark Mode) ---
        const getDarkMode = () => {
          if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
            return localStorage.getItem('theme');
          }
          return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        };

        const theme = getDarkMode();
        if (theme === 'dark') {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }

        // --- B. 处理自定义颜色主题 (App Theme - 紫色/绿色等) ---
        const savedAppTheme = localStorage.getItem('app-theme');
        if (savedAppTheme) {
          document.documentElement.setAttribute('data-theme', savedAppTheme);
        } else {
          document.documentElement.removeAttribute('data-theme');
        }
      };

      // 1. 页面初次加载时立即运行
      initAllThemes();

      // 2. 监听 Astro 页面切换，确保跳转后样式不丢失
      document.addEventListener('astro:after-swap', initAllThemes);
    </script>
  </head>
  
  <!-- ✅ 3. 修改点：body 添加 overflow-x-hidden 和 w-full 防止横向溢出 -->
  <body class="bg-slate-50 dark:bg-[#0b0f1a] transition-colors duration-500 overflow-x-hidden w-full">
    
    <!-- ✅ 4. 保留背景光斑装饰 -->
    <div class="fixed inset-0 -z-10 overflow-hidden pointer-events-none">
      <div class="absolute -top-[10%] -left-[10%] w-[40%] h-[40%] rounded-full bg-blue-400/10 dark:bg-blue-600/5 blur-[100px]"></div>
      <div class="absolute -bottom-[10%] -right-[10%] w-[40%] h-[40%] rounded-full bg-purple-400/10 dark:bg-purple-600/5 blur-[100px]"></div>
    </div>

    <slot />

    <!-- ✅ 5. 保留原有暗色模式按钮逻辑 (Sun/Moon Toggle) -->
    <script is:inline>
      function setupThemeToggle() {
        const btn = document.getElementById('theme-toggle');
        if (!btn) return;

        // 克隆节点以移除旧监听器 (防止重复绑定)
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);

        newBtn.addEventListener('click', () => {
          const isDark = document.documentElement.classList.contains('dark');
          const newTheme = isDark ? 'light' : 'dark';
          
          if (newTheme === 'dark') {
            document.documentElement.classList.add('dark');
          } else {
            document.documentElement.classList.remove('dark');
          }
          localStorage.setItem('theme', newTheme);
        });
      }

      // 初始化 + 页面切换后重新绑定
      setupThemeToggle();
      document.addEventListener('astro:after-swap', setupThemeToggle);
    </script>
  </body>
</html>

<!-- ✅ 6. 新增全局样式重置：强制禁止横向滚动 -->
<style is:global>

  html, body {
    overflow-x: hidden;
    width: 100%;
    max-width: 100%;
    margin: 0;
    padding: 0;
  }
  
/* 强制锁定滚动，防止被其他样式覆盖 */
html.overflow-hidden,
body.overflow-hidden {
  overflow: hidden !important;
  height: 100vh !important;
  touch-action: none; /* 禁止触摸动作 */
}
</style>