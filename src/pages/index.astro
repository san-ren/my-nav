---
import Layout from '../layouts/Layout.astro';
import Sidebar from '../components/Sidebar.astro'; // 引入 Sidebar
import SiteCard from '../components/SiteCard.astro';
import SearchModal from '../components/SearchModal.jsx';
import siteConfig from '../data/config.json';
import { LayoutDashboard, Star, Code, Palette, Edit, Sun, Moon } from 'lucide-react';

// 1. 获取所有文件
const allNavFiles = import.meta.glob('../data/nav/*.json', { eager: true });
let navResources = Object.values(allNavFiles);

// 2. 排序逻辑
navResources.sort((a: any, b: any) => {
  return (a.sortOrder || 99) - (b.sortOrder || 99);
});

// 3. 定义变量
const section = navResources[0]; // 默认取第一个
const id = section.id;

const Icons = { Star, Code, Palette, LayoutDashboard };
const CurrentIcon = Icons[section.icon] || LayoutDashboard;
---

<Layout title={`${section.name} - ${siteConfig.title}`}>
  <div class="flex min-h-screen">
    
    <!-- 使用 Sidebar 组件 -->
    <Sidebar navResources={navResources} currentId={id} siteConfig={siteConfig} />

    <main class="flex-1 md:ml-64">
      <header class="sticky top-0 z-30 flex items-center justify-between px-8 py-4 bg-white/40 dark:bg-gray-900/40 backdrop-blur-md border-b border-slate-200/50 dark:border-gray-800/50">
        <h1 class="text-xl font-black flex items-center gap-3 text-slate-800 dark:text-white">
          <div class="p-2 bg-blue-50 dark:bg-blue-900/30 rounded-lg text-blue-600"><CurrentIcon size={20} /></div>
          {section.name}
        </h1>
        <div class="flex items-center gap-3">
          <SearchModal client:load />
          <button id="theme-toggle" class="p-2.5 bg-slate-100 dark:bg-gray-800 rounded-xl text-slate-500 hover:text-blue-600 transition-all">
            <Sun size={20} className="hidden dark:block" />
            <Moon size={20} className="block dark:hidden" />
          </button>
        </div>
      </header>

      <div class="p-8 space-y-16 max-w-7xl">
        {section.categories.map((category, catIdx) => (
          <section class="category-group">
            <div class="flex flex-row items-center justify-start gap-8 mb-8">
              <h2 class="flex items-center gap-3 text-lg font-bold text-slate-800 dark:text-slate-100 shrink-0">
                <span class="w-2 h-7 bg-gradient-to-b from-blue-500 to-indigo-600 rounded-full shadow-lg shadow-blue-500/20"></span>
                {category.name}
              </h2>

              {category.tabs && (
                <div class="flex bg-slate-200/50 dark:bg-gray-800/50 p-1 rounded-2xl gap-1 backdrop-blur-sm">
                  {category.tabs.map((tab, tabIdx) => (
                    <button
                      class={`tab-btn px-6 py-1.5 text-xs font-bold rounded-xl transition-all duration-300
                      ${tabIdx === 0 
                        ? 'bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow-lg shadow-blue-500/40 scale-105' 
                        : 'text-slate-500 hover:text-slate-800 dark:text-slate-400'
                      }`}
                      data-target={`pane-${catIdx}-${tabIdx}`}
                    >
                      {tab.tabName}
                    </button>
                  ))}
                </div>
              )}
            </div>

            <div class="tab-content">
              {category.tabs ? (
                category.tabs.map((tab, tabIdx) => (
                  <div id={`pane-${catIdx}-${tabIdx}`} class={`grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-6 tab-pane ${tabIdx !== 0 ? 'hidden' : ''}`}>
                    {tab.list.map((site) => <SiteCard {...site} />)}
                  </div>
                ))
              ) : (
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                  {category.list?.map((site) => <SiteCard {...site} />)}
                </div>
              )}
            </div>
          </section>
        ))}
        
        <footer class="mt-20 py-10 text-center text-[13px] text-slate-400 border-t border-slate-200/50 dark:border-gray-800/50">
          <p>Made with ❤️ by {siteConfig.author} © {new Date().getFullYear()}</p>
        </footer>
      </div>
    </main>
  </div>
</Layout>

<script is:inline>
  function initTabs() {
    const tabButtons = document.querySelectorAll('.tab-btn');
    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const parent = btn.closest('.category-group');
        const targetId = btn.getAttribute('data-target');

        parent.querySelectorAll('.tab-btn').forEach(b => {
          b.classList.remove('bg-gradient-to-r', 'from-blue-600', 'to-indigo-600', 'text-white', 'shadow-lg', 'shadow-blue-500/40', 'scale-105');
          b.classList.add('text-slate-500');
        });
        btn.classList.add('bg-gradient-to-r', 'from-blue-600', 'to-indigo-600', 'text-white', 'shadow-lg', 'shadow-blue-500/40', 'scale-105');
        btn.classList.remove('text-slate-500');

        parent.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
        document.getElementById(targetId).classList.remove('hidden');
      });
    });
  }
  initTabs();
  document.addEventListener('astro:after-swap', initTabs);
</script>