---
import Layout from '../layouts/Layout.astro';
import Sidebar from '../components/Sidebar/index.astro';
import siteConfig from '../content/site-settings/config.json';
import { getCollection } from 'astro:content';
import { History, ArrowLeft, Rocket, BookOpen } from 'lucide-react';
import Container from '../components/mdx/Container.astro';
import '../styles/mdx.css';
// 1. 引入新样式
import '../styles/changelog.css';

// 获取数据
const allLogs = await getCollection('changelog');

// 2. 过滤草稿 (生产环境隐藏草稿，开发环境显示草稿)
const visibleLogs = allLogs.filter(log => {
  if (import.meta.env.DEV) return true; // 开发模式全显示
  return log.data.status !== 'draft'; // 生产模式只显示非 draft
});

// 排序
visibleLogs.sort((a, b) => {
  const dateA = new Date(a.data.date).valueOf();
  const dateB = new Date(b.data.date).valueOf();
  return (isNaN(dateB) ? 0 : dateB) - (isNaN(dateA) ? 0 : dateA);
});

const functionLogs = visibleLogs.filter(log => log.data.type === 'function');
const contentLogs = visibleLogs.filter(log => log.data.type === 'content');

const allPages = await getCollection('nav-pages');
const navResources = allPages.map(p => p.data).sort((a, b) => (a.sortOrder || 99) - (b.sortOrder || 99));
---

<Layout title={`更新日志 - ${siteConfig.title}`}>
  <div class="flex min-h-screen w-full bg-slate-50 dark:bg-gray-900">
    <Sidebar navResources={navResources} currentId="changelog" siteConfig={siteConfig} />
    <div id="sidebar-overlay"></div>

    <main class="layout-transition flex-1 min-w-0 md:ml-[var(--sidebar-width,17rem)] min-h-screen flex flex-col">
      <header id="page-header" class="fixed top-0 right-0 z-30 flex items-center px-8 py-4 bg-white/80 dark:bg-gray-900/80 backdrop-blur-md border-b border-slate-200/50 w-full md:w-[calc(100%-var(--sidebar-width,17rem))]">
         <h1 class="text-xl font-black flex items-center gap-2 text-slate-800 dark:text-white">
            <History className="text-brand-600" /> 更新记录
         </h1>
      </header>

      <div class="p-4 pt-24 md:p-8 md:pt-28 w-full max-w-6xl mx-auto">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-16">
          
          {/* 左侧：功能更新 */}
          <section>
            <div class="flex items-center gap-2 mb-8 pb-2 border-b border-slate-200 dark:border-gray-800">
              <span class="p-1.5 bg-blue-100 text-blue-600 rounded-lg"><Rocket size={20} /></span>
              <h2 class="text-xl font-bold text-slate-800 dark:text-slate-100">功能更新 ({functionLogs.length})</h2>
            </div>
            
            {/* 3. 应用新的CSS结构 */}
            <div class="changelog-timeline space-y-2">
              {functionLogs.length > 0 ?
                functionLogs.map(async (log) => {
                const { Content } = await log.render();
                const displayVersion = log.data.version || log.id.replace(/\.mdx?$/, '') || log.slug;
                // 判断是否是草稿，如果是，加个标记 (仅开发环境可见)
                const isDraft = log.data.status === 'draft';

                return (
                  <div class="changelog-item">
                    {/* 圆点 (蓝色) */}
                    <div class="changelog-dot bg-blue-500"></div>
                    
                    <div class="flex flex-col">
                      <div class="changelog-header">
                        <h3 class="changelog-version text-slate-800 dark:text-slate-200 flex items-center gap-2">
                            {displayVersion}
                            {isDraft && <span class="text-xs bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded border border-yellow-200">草稿</span>}
                        </h3>
                        <time class="changelog-date text-slate-400">
                          {new Date(log.data.date).toLocaleDateString()}
                        </time>
                      </div>
        
                      <div class="changelog-card prose prose-sm prose-slate dark:prose-invert max-w-none">
                        <div class="changelog-content">
                            <Content components={{ container: Container }} />
                        </div>
                      </div>
                    </div>
                  </div>
                );
              }) : (
                <div class="text-slate-400 text-sm italic pl-4">暂无功能更新...</div>
              )}
            </div>
          </section>

          {/* 右侧：内容更新 */}
          <section>
            <div class="flex items-center gap-2 mb-8 pb-2 border-b border-slate-200 dark:border-gray-800">
              <span class="p-1.5 bg-green-100 text-green-600 rounded-lg"><BookOpen size={20} /></span>
              <h2 class="text-xl font-bold text-slate-800 dark:text-slate-100">内容更新 ({contentLogs.length})</h2>
            </div>

            <div class="changelog-timeline space-y-2">
              {contentLogs.length > 0 ?
                contentLogs.map(async (log) => {
                const { Content } = await log.render();
                const displayVersion = log.data.version || log.id.replace(/\.mdx?$/, '') || log.slug;
                const isDraft = log.data.status === 'draft';

                return (
                  <div class="changelog-item">
                    {/* 圆点 (绿色) */}
                    <div class="changelog-dot bg-green-500"></div>
                    
                    <div class="flex flex-col">
                      <div class="changelog-header">
                        <h3 class="changelog-version text-slate-800 dark:text-slate-200 flex items-center gap-2">
                            {displayVersion}
                            {isDraft && <span class="text-xs bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded border border-yellow-200">草稿</span>}
                        </h3>
                        <time class="changelog-date text-slate-400">
                          {new Date(log.data.date).toLocaleDateString()}
                        </time>
                      </div>
        
                      <div class="changelog-card prose prose-sm prose-slate dark:prose-invert max-w-none">
                         <div class="changelog-content">
                            <Content components={{ container: Container }} />
                         </div>
                      </div>
                    </div>
                  </div>
                );
              }) : (
                <div class="text-slate-400 text-sm italic pl-4">暂无内容更新...</div>
              )}
            </div>
          </section>

        </div>
      </div>
    </main>
  </div>
</Layout>