---
import Layout from '../layouts/Layout.astro';
import Sidebar from '../components/Sidebar/index.astro';
import siteConfig from '../content/site-settings/config.json';
import { getCollection } from 'astro:content';
import { History, ArrowLeft, Rocket, BookOpen } from 'lucide-react';

import Container from '../components/mdx/Container.astro';
import '../styles/mdx.css'; 


// è·å–æ•°æ®
const allLogs = await getCollection('changelog');

// æ’åº
allLogs.sort((a, b) => {
  const dateA = new Date(a.data.date).valueOf();
  const dateB = new Date(b.data.date).valueOf();
  return (isNaN(dateB) ? 0 : dateB) - (isNaN(dateA) ? 0 : dateA);
});

const functionLogs = allLogs.filter(log => log.data.type === 'function');
const contentLogs = allLogs.filter(log => log.data.type === 'content');

const allPages = await getCollection('nav-pages');
const navResources = allPages.map(p => p.data).sort((a, b) => (a.sortOrder || 99) - (b.sortOrder || 99));
---

<Layout title={`æ›´æ–°æ—¥å¿— - ${siteConfig.title}`}>
  <div class="flex min-h-screen w-full bg-slate-50 dark:bg-gray-900">
    <Sidebar navResources={navResources} currentId="changelog" siteConfig={siteConfig} />
    <div id="sidebar-overlay"></div>

    <main class="layout-transition flex-1 min-w-0 md:ml-[var(--sidebar-width,17rem)] min-h-screen flex flex-col">
      <header id="page-header" class="fixed top-0 right-0 z-30 flex items-center px-8 py-4 bg-white/80 dark:bg-gray-900/80 backdrop-blur-md border-b border-slate-200/50 w-full md:w-[calc(100%-var(--sidebar-width,17rem))]">
         <h1 class="text-xl font-black flex items-center gap-2 text-slate-800 dark:text-white">
            <History className="text-brand-600" /> æ›´æ–°è®°å½•
         </h1>
      </header>

      <div class="p-4 pt-24 md:p-8 md:pt-28 w-full max-w-6xl mx-auto">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-16">
          
          {/* å·¦ä¾§ï¼šåŠŸèƒ½æ›´æ–° */}
          <section>
            <div class="flex items-center gap-2 mb-8 pb-2 border-b border-slate-200 dark:border-gray-800">
              <span class="p-1.5 bg-blue-100 text-blue-600 rounded-lg"><Rocket size={20} /></span>
              <h2 class="text-xl font-bold text-slate-800 dark:text-slate-100">åŠŸèƒ½æ›´æ–° ({functionLogs.length})</h2>
            </div>
            
            <div class="relative pl-6 border-l-2 border-slate-200 dark:border-slate-800 space-y-10">
              {functionLogs.length > 0 ? functionLogs.map(async (log) => {
                const { Content } = await log.render();
                const displayVersion = log.data.version || log.id.replace(/\.mdx?$/, '') || log.slug;

                return (
                  <div class="relative">
                    <div class="absolute -left-[31px] top-1 w-3 h-3 rounded-full bg-blue-500 border-4 border-white dark:border-gray-900 shadow-sm"></div>
                    <div class="flex flex-col gap-2">
                      <div class="flex items-baseline justify-between">
                        <h3 class="text-lg font-bold text-slate-800 dark:text-slate-200">{displayVersion}</h3>
                        <time class="text-xs font-mono text-slate-400">
                          {new Date(log.data.date).toLocaleDateString()}
                        </time>
                      </div>
                      <div class="prose prose-sm prose-slate dark:prose-invert bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700/50">
                        {/* ğŸ”¥ æ³¨å…¥ç»„ä»¶ */}
                        <Content components={{ container: Container }} />
                      </div>
                    </div>
                  </div>
                );
              }) : (
                <div class="text-slate-400 text-sm italic">æš‚æ— åŠŸèƒ½æ›´æ–°...</div>
              )}
            </div>
          </section>

          {/* å³ä¾§ï¼šå†…å®¹æ›´æ–° */}
          <section>
            <div class="flex items-center gap-2 mb-8 pb-2 border-b border-slate-200 dark:border-gray-800">
              <span class="p-1.5 bg-green-100 text-green-600 rounded-lg"><BookOpen size={20} /></span>
              <h2 class="text-xl font-bold text-slate-800 dark:text-slate-100">å†…å®¹æ›´æ–° ({contentLogs.length})</h2>
            </div>

            <div class="relative pl-6 border-l-2 border-slate-200 dark:border-slate-800 space-y-10">
              {contentLogs.length > 0 ? contentLogs.map(async (log) => {
                const { Content } = await log.render();
                const displayVersion = log.data.version || log.id.replace(/\.mdx?$/, '') || log.slug;

                return (
                  <div class="relative">
                    <div class="absolute -left-[31px] top-1 w-3 h-3 rounded-full bg-green-500 border-4 border-white dark:border-gray-900 shadow-sm"></div>
                    <div class="flex flex-col gap-2">
                      <div class="flex items-baseline justify-between">
                        <h3 class="text-lg font-bold text-slate-800 dark:text-slate-200">{displayVersion}</h3>
                        <time class="text-xs font-mono text-slate-400">
                          {new Date(log.data.date).toLocaleDateString()}
                        </time>
                      </div>
                      <div class="prose prose-sm prose-slate dark:prose-invert bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700/50">
                        {/* ğŸ”¥ æ³¨å…¥ç»„ä»¶ */}
                        <Content components={{ details: Details, container: Container }} />
                      </div>
                    </div>
                  </div>
                );
              }) : (
                <div class="text-slate-400 text-sm italic">æš‚æ— å†…å®¹æ›´æ–°...</div>
              )}
            </div>
          </section>

        </div>
      </div>
    </main>
  </div>
</Layout>

