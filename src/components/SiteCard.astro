---
import { marked } from 'marked';
import { BookOpen, Info } from 'lucide-react';

const { title, name, url, icon, desc, detail, official_site, badge_list = [], guide_id } = Astro.props;
const displayTitle = title || name;
const base = import.meta.env.BASE_URL.replace(/\/$/, '');

const getDomain = (targetUrl) => {
  try {
    if (!targetUrl) return null;
    return new URL(targetUrl).hostname;
  } catch (e) {
    return null;
  }
};

const domain = getDomain(official_site) || getDomain(url);

// æœ¬åœ°ç§’å¼€å›¾æ ‡
const localFallback = `${base}/favicon.svg`;

const iconSources = {
  custom: icon,
  level1: domain ? `https://ico.kucat.cn/get.php?url=${domain}` : '',
  level2: domain ? `https://${domain}/favicon.ico` : '',
  level3: domain ? `https://www.google.com/s2/favicons?domain=${domain}&sz=128` : '', 
  fallback: localFallback
};

const targetIcon = iconSources.custom || iconSources.level1 || iconSources.fallback;

let badges = [];
if (url && url.includes("github.com") && badge_list && badge_list.length > 0) {
  try {
    const pathParts = new URL(url).pathname.split('/').filter(Boolean);
    if (pathParts.length >= 2) {
      const owner = pathParts[0];
      const repo = pathParts[1];
      const styleParam = "?style=flat&color=blue"; 
      const badgeConfigs = {
        stars: { src: `https://img.shields.io/github/stars/${owner}/${repo}${styleParam}&label=Stars`, alt: "Stars" },
        version: { src: `https://img.shields.io/github/v/release/${owner}/${repo}${styleParam}&color=orange&label=Release`, alt: "Version" },
        license: { src: `https://img.shields.io/github/license/${owner}/${repo}${styleParam}&color=green&label=License`, alt: "License" },
        last_commit: { src: `https://img.shields.io/github/last-commit/${owner}/${repo}${styleParam}&color=slate&label=Last%20Commit`, alt: "Last Commit" }
      };
      badge_list.forEach(key => { if (badgeConfigs[key]) badges.push(badgeConfigs[key]); });
    }
  } catch(e) { console.error("Badge error", e); }
}
if (url && url.includes("marketplace.visualstudio.com")) {
  try {
    const urlObj = new URL(url);
    const itemId = urlObj.searchParams.get('itemName');
    if (itemId) {
      const styleParam = "?style=flat";
      const vsBadges = [
        { src: `https://img.shields.io/visual-studio-marketplace/i/${itemId}${styleParam}&color=blue&label=Installs`, alt: "Installs" },
        { src: `https://img.shields.io/visual-studio-marketplace/v/${itemId}${styleParam}&color=orange&label=Version`, alt: "Version" },
        { src: `https://img.shields.io/visual-studio-marketplace/last-updated/${itemId}${styleParam}&color=slate&label=Updated`, alt: "Last Updated" }
      ];
      vsBadges.forEach(b => badges.push(b));
    }
  } catch(e) { console.error("VS Code Badge error", e); }
}

const rawMarkdown = detail || "";
const detailContent = marked.parse(rawMarkdown, { gfm: true, breaks: true });
const cardId = `site-${domain ? domain.replace(/[^a-zA-Z0-9]/g, '-') : Math.random().toString(36).substr(2, 9)}`;
const hasPopup = !!(detail || (badges && badges.length > 0));
---

<div class="site-card-wrapper group relative w-full h-full">
  <a href={url} target="_blank" 
     class={`flex items-center justify-between w-full h-full py-3 pl-3 pr-2
            bg-white/70 dark:bg-gray-800/60 backdrop-blur-xl rounded-xl 
            border border-white/60 dark:border-gray-700/50 
            transition-all duration-300 ease-[cubic-bezier(0.25,0.8,0.25,1)]
            
            hover:-translate-y-1.5 
            hover:bg-white/95 dark:hover:bg-gray-800/95
            hover:border-brand-500/30 dark:hover:border-brand-400/30
            hover:shadow-xl hover:shadow-brand-600/10 
            hover:ring-1 hover:ring-brand-500/20
            
            relative overflow-hidden`}
  >
    <div class="flex items-center flex-1 min-w-0 mr-1">
        <div class="relative flex-shrink-0 mr-3 w-10 h-10 flex items-center justify-center">
          <!-- å…‰å½±å±‚ -->
          <div class="absolute inset-0 z-0 transition-all duration-500 ease-out opacity-0 group-hover:opacity-50 group-hover:scale-150 filter blur-lg saturate-150 pointer-events-none transform-gpu">
             <img src={localFallback} data-lazy-src={targetIcon} alt="" class="lazy-icon w-full h-full object-contain" aria-hidden="true" />
          </div>
          <!-- å®ä½“å›¾æ ‡ -->
          <div class="relative z-10 w-10 h-10 rounded-lg bg-white/80 dark:bg-gray-700/90 shadow-sm flex items-center justify-center border border-gray-100 dark:border-gray-600 group-hover:scale-105 group-hover:shadow-md transition-all duration-300">
            <img 
              id={cardId}
              src={localFallback}
              data-lazy-src={targetIcon}
              data-domain={domain}
              data-sources={JSON.stringify(iconSources)}
              alt={displayTitle} 
              loading="lazy" 
              referrerpolicy="no-referrer"
              class="lazy-icon w-6 h-6 object-contain transition-transform duration-300" 
            />
          </div>
        </div>
        
        <div class="flex-1 min-w-0 relative z-20">
          <h3 class="font-heading font-bold text-[14px] text-slate-800 dark:text-slate-100 truncate mb-0.5 text-left group-hover:text-brand-600 transition-colors duration-200">
            {displayTitle}
          </h3>
          {desc && (
            <p class="font-body text-[12px] text-slate-400 dark:text-slate-500 leading-tight line-clamp-1 overflow-hidden text-left break-words opacity-80 group-hover:opacity-100 transition-opacity">
              {desc}
            </p>
          )}
        </div>
    </div>

    <div class={`flex flex-col gap-1 shrink-0 pl-1 border-l border-slate-100 dark:border-slate-700/50 
                 transition-all duration-200 z-20
                 opacity-100 translate-x-0
                 md:opacity-0 md:-translate-x-2 
                 md:group-hover:opacity-100 md:group-hover:translate-x-0`}>
        {hasPopup && (
          <button type="button" class="info-btn md:hidden p-1 rounded-md text-slate-400 hover:text-brand-600 hover:bg-brand-50 dark:hover:bg-gray-700 transition-all flex items-center justify-center" title="è¯¦æƒ…">
            <Info size={14} />
          </button>
        )}
        {guide_id && (
          <button onclick={`event.preventDefault(); event.stopPropagation(); window.open('${base}/guide/${guide_id}', '_blank');`} class="p-1 rounded-md text-brand-400 hover:bg-brand-600 hover:text-white transition-all flex items-center justify-center" title="æ•™ç¨‹">
            <BookOpen size={14} strokeWidth={2.5} />
          </button>
        )}
    </div>
  </a>

  {hasPopup && (
    <div class="tooltip-source hidden">
      <div class="relative z-10">
        <div class="text-[11px] font-black text-brand-600 dark:text-brand-400 mb-2 flex items-center gap-2 uppercase tracking-widest font-body">
          <span class="w-1.5 h-3 bg-brand-600 rounded-sm"></span>è¯¦æƒ…
        </div>
        {badges.length > 0 && (
          <div class="flex flex-wrap gap-2 mb-2 border-b border-slate-100 dark:border-slate-800 pb-2">
            {badges.map(b => <img src={b.src} alt={b.alt} class="h-4 rounded-sm" />)}
          </div>
        )}
        {detail && (
          <div class="detail-markdown font-body text-[13px] text-slate-700 dark:text-slate-300 leading-relaxed break-words" set:html={detailContent}></div>
        )}
      </div>
    </div>
  )}
</div>

<script is:inline>
  (function() {
    // -------------------------------------------------------------
    // å›¾ç‰‡åŠ è½½é€»è¾‘ (ä¿æŒä¸å˜ï¼Œçœç•¥ä»¥èŠ‚çœç©ºé—´ï¼Œè¯·ä¿ç•™åŸæœ‰çš„)
    // -------------------------------------------------------------
    function loadOneImage(img) { /* ...ä¿ç•™ä½ åŸæœ‰çš„ä»£ç ... */ 
      if (img.dataset.loaded === 'true') return;
      const realSrc = img.dataset.lazySrc;
      const sources = img.dataset.sources ? JSON.parse(img.dataset.sources) : null;
      const domain = img.dataset.domain;
      if (domain) {
         const cached = localStorage.getItem('fav-' + domain);
         if (cached) { img.src = cached; img.dataset.loaded = 'true'; return; }
      }
      const tempImage = new Image();
      tempImage.onload = () => {
        img.src = realSrc;
        img.dataset.loaded = 'true';
        if (domain && !realSrc.includes('favicon.svg')) {
           try { localStorage.setItem('fav-' + domain, realSrc); } catch(e){}
        }
      };
      tempImage.onerror = () => {
        if (sources) {
           if (realSrc.includes('ico.kucat.cn')) img.src = sources.level2;
           else if (realSrc.includes('/favicon.ico')) img.src = sources.level3;
           else img.dataset.loaded = 'true'; 
        }
      };
      if (realSrc) tempImage.src = realSrc;
    }

    function initObserver() { /* ...ä¿ç•™ä½ åŸæœ‰çš„ä»£ç ... */
      const imgs = document.querySelectorAll('img.lazy-icon:not([data-loaded="true"])');
      if ('IntersectionObserver' in window) {
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              loadOneImage(entry.target);
              observer.unobserve(entry.target);
            }
          });
        }, { rootMargin: '200px 0px', threshold: 0.01 });
        imgs.forEach(img => observer.observe(img));
      } else {
        imgs.forEach(img => loadOneImage(img));
      }
    }

    function loadRestIcons() { /* ...ä¿ç•™ä½ åŸæœ‰çš„ä»£ç ... */
      const idleCallback = window.requestIdleCallback || ((cb) => setTimeout(cb, 2000));
      idleCallback(() => {
        const allImgs = document.querySelectorAll('img.lazy-icon:not([data-loaded="true"])');
        allImgs.forEach(img => loadOneImage(img));
      }, { timeout: 5000 });
    }

    function startLoading() {
      initObserver();
      if (document.readyState === 'complete') { loadRestIcons(); } 
      else { window.addEventListener('load', loadRestIcons); }
    }
    document.addEventListener('astro:page-load', startLoading);
    startLoading();

    // -------------------------------------------------------------
    // æµ®çª—é€»è¾‘ (ğŸ”¥ é’ˆå¯¹ç§»åŠ¨ç«¯æ»šåŠ¨ä¼˜åŒ–)
    // -------------------------------------------------------------
    let tooltipEl = null;
    let hideTimer = null;
    let activeCard = null;

    function createTooltipDOM() {
      if (document.getElementById('global-detail-tooltip')) {
        tooltipEl = document.getElementById('global-detail-tooltip');
        return;
      }
      tooltipEl = document.createElement('div');
      tooltipEl.id = 'global-detail-tooltip';
      // æ³¨æ„ï¼šè¿™é‡Œä¿ç•™äº† transitionï¼Œä½†åœ¨æ»šåŠ¨éšè—æ—¶æˆ‘ä»¬ä¼šä¸´æ—¶å…³æ‰å®ƒ
      tooltipEl.className = 'portal-popup fixed z-[9999] hidden w-72 p-4 bg-white dark:bg-[#1e2025] rounded-xl shadow-2xl border border-slate-200/60 dark:border-slate-700 pointer-events-none opacity-0 scale-75 transition-all duration-300 ease-[cubic-bezier(0.34,1.56,0.64,1)]';
      
      const arrow = document.createElement('div');
      arrow.className = 'tooltip-arrow-el absolute w-4 h-4 border-r border-b border-slate-200 dark:border-slate-700 rotate-45 bg-white dark:bg-[#1e2025] z-0';
      tooltipEl.appendChild(arrow);

      const content = document.createElement('div');
      content.id = 'tooltip-content';
      content.className = 'relative z-10';
      tooltipEl.appendChild(content);
      document.body.appendChild(tooltipEl);
    }

    function showTooltip(wrapper) {
      if (!tooltipEl) createTooltipDOM();
      if (hideTimer) { clearTimeout(hideTimer); hideTimer = null; }

      // æ¿€æ´»æµå…‰è¾¹æ¡†
      wrapper.classList.add('flow-active');

      const source = wrapper.querySelector('.tooltip-source');
      if (!source) return;

      const contentBox = document.getElementById('tooltip-content');
      contentBox.innerHTML = source.innerHTML;

      // é‡ç½® Transitionï¼Œç¡®ä¿æ˜¾ç¤ºåŠ¨ç”»æµç•…
      tooltipEl.style.transition = ''; 
      tooltipEl.classList.remove('hidden', 'scale-75', 'opacity-0');
      tooltipEl.classList.add('scale-100', 'opacity-0'); 
      updatePosition(wrapper);
      
      // è§¦å‘åŠ¨ç”»
      tooltipEl.classList.remove('scale-100');
      tooltipEl.classList.add('scale-75');
      void tooltipEl.offsetWidth;
      
      requestAnimationFrame(() => {
        tooltipEl.classList.remove('opacity-0', 'scale-75');
        tooltipEl.classList.add('opacity-100', 'scale-100');
      });
    }

    function hideTooltip(immediate = false) {
      if (!tooltipEl) return;
      
      // ç§»é™¤æµå…‰è¾¹æ¡†
      if (activeCard) {
        activeCard.classList.remove('flow-active');
      }

      if (immediate) {
         // ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ï¼šå¦‚æœæ˜¯ç«‹å³å…³é—­ï¼ˆæ¯”å¦‚æ»šåŠ¨æ—¶ï¼‰ï¼Œç›´æ¥å¹²æ‰ Transition
         // è¿™æ ·å¯ä»¥é˜²æ­¢æµ®çª—åœ¨åŸåœ°"æ·¡å‡º" 2ç§’é’Ÿ
         tooltipEl.style.transition = 'none';
         tooltipEl.classList.add('hidden', 'opacity-0', 'scale-75');
         tooltipEl.classList.remove('opacity-100', 'scale-100');
         activeCard = null;
      } else {
        // æ­£å¸¸é¼ æ ‡ç§»å‡ºçš„å…³é—­ï¼Œä¿ç•™æ·¡å‡ºåŠ¨ç”»
        tooltipEl.style.transition = '';
        tooltipEl.classList.remove('opacity-100', 'scale-100');
        tooltipEl.classList.add('opacity-0', 'scale-75');
        
        if (hideTimer) clearTimeout(hideTimer);
        hideTimer = setTimeout(() => {
          if (tooltipEl && tooltipEl.classList.contains('opacity-0')) {
            tooltipEl.classList.add('hidden');
            activeCard = null;
          }
          hideTimer = null;
        }, 300);
      }
    }

    function updatePosition(wrapper) {
      if (!tooltipEl) return;
      const rect = wrapper.getBoundingClientRect();
      const tooltipRect = tooltipEl.getBoundingClientRect();
      const padding = 12; 
      const sidebarEl = document.getElementById('sidebar');
      const sidebarRight = (sidebarEl && window.innerWidth >= 768) ? sidebarEl.getBoundingClientRect().right : 0;

      let top = rect.top - tooltipRect.height - padding;
      let isTop = true;
      if (top < padding && (rect.bottom + tooltipRect.height + padding < window.innerHeight)) { 
        top = rect.bottom + padding;
        isTop = false;
      }

      tooltipEl.style.transformOrigin = isTop ? 'bottom center' : 'top center';
      let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
      
      const minLeft = sidebarRight + padding;
      if (left < minLeft) left = minLeft;
      
      if (left + tooltipRect.width > window.innerWidth - padding) {
        left = window.innerWidth - tooltipRect.width - padding;
      }

      let arrowLeft = rect.left + (rect.width / 2) - left - 8;
      arrowLeft = Math.max(12, Math.min(tooltipRect.width - 28, arrowLeft));

      tooltipEl.style.top = `${top}px`;
      tooltipEl.style.left = `${left}px`;
      
      const arrow = tooltipEl.querySelector('.tooltip-arrow-el');
      arrow.style.left = `${arrowLeft}px`;
      if (isTop) {
        arrow.style.bottom = '-8px'; arrow.style.top = 'auto'; arrow.style.transform = 'rotate(45deg)'; 
      } else {
        arrow.style.top = '-8px'; arrow.style.bottom = 'auto'; arrow.style.transform = 'rotate(225deg)'; 
      }
    }

    const handleMouseOver = (e) => {
      if (window.innerWidth < 768) return; 
      const wrapper = e.target.closest('.site-card-wrapper');
      if (wrapper) {
        if (activeCard !== wrapper && wrapper.querySelector('.tooltip-source')) {
          if (activeCard) activeCard.classList.remove('flow-active');
          activeCard = wrapper;
          showTooltip(wrapper);
        }
      } else {
        if (activeCard) {
          const isTooltip = e.target.closest('#global-detail-tooltip');
          if (!isTooltip) {
            hideTooltip();
          }
        }
      }
    };

    const handleClick = (e) => {
      const btn = e.target.closest('.info-btn');
      if (btn) {
        e.preventDefault(); e.stopPropagation();
        const wrapper = btn.closest('.site-card-wrapper');
        if (wrapper) {
           if (activeCard === wrapper && !tooltipEl.classList.contains('hidden')) hideTooltip();
           else { 
             if(activeCard) activeCard.classList.remove('flow-active');
             activeCard = wrapper; 
             showTooltip(wrapper); 
           }
        }
        return;
      }
      if (tooltipEl && !tooltipEl.classList.contains('hidden')) {
        if (!e.target.closest('.site-card-wrapper') && !e.target.closest('#global-detail-tooltip')) {
          hideTooltip();
        }
      }
    };
    
    // æ»šåŠ¨æ—¶ç«‹å³éšè—
    const handleScroll = () => { if (activeCard) hideTooltip(true); };
    const handleDocMouseLeave = () => { if (activeCard) hideTooltip(true); };
    const handleWindowBlur = () => { if (activeCard) hideTooltip(true); };

    function init() {
      createTooltipDOM();
      
      // æ¸…ç†æ—§ç›‘å¬å™¨
      document.body.removeEventListener('mouseover', handleMouseOver);
      document.body.removeEventListener('click', handleClick);
      document.removeEventListener('mouseleave', handleDocMouseLeave);
      window.removeEventListener('scroll', handleScroll, { capture: true });
      window.removeEventListener('touchmove', handleScroll); // ç§»é™¤æ—§çš„è§¦æ‘¸ç›‘å¬
      window.removeEventListener('blur', handleWindowBlur);

      // æ·»åŠ æ–°ç›‘å¬å™¨
      document.body.addEventListener('mouseover', handleMouseOver);
      document.body.addEventListener('click', handleClick);
      document.addEventListener('mouseleave', handleDocMouseLeave);
      
      // ğŸ”¥ æ ¸å¿ƒï¼šç›‘å¬ scroll (PC) å’Œ touchmove (ç§»åŠ¨ç«¯)
      // touchmove ä¼šåœ¨æ‰‹æŒ‡æ»‘åŠ¨å±å¹•çš„ç¬é—´è§¦å‘ï¼Œæ¯” scroll æ›´å¿«
      window.addEventListener('scroll', handleScroll, { capture: true, passive: true });
      window.addEventListener('touchmove', handleScroll, { passive: true }); // æ–°å¢è¿™ä¸€è¡Œ
      
      window.addEventListener('blur', handleWindowBlur);
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
    document.addEventListener('astro:after-swap', init);
    document.addEventListener('astro:page-load', init);
  })();
</script>

<style is:global>
  /* åŸºç¡€ Markdown æ ·å¼ (ä¿æŒä¸å˜) */
  .detail-markdown p { margin-bottom: 0.5rem; }
  .detail-markdown p:last-child { margin-bottom: 0; }
  .detail-markdown ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.5rem; }
  .detail-markdown li { margin-bottom: 0.2rem; }
  .detail-markdown a { color: #3b82f6; text-decoration: underline; }
  .detail-markdown del { text-decoration: line-through; opacity: 0.7; }

  /* 
    ğŸ”¥ ä¼˜åŒ–åçš„æµå…‰åŠ¨ç”»ï¼šæ¨¡æ‹Ÿå…‰æŸåˆ’è¿‡
  */
  @keyframes beamFlow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
  }

  /* 
     ä½¿ç”¨ ::after ä¼ªå…ƒç´ åˆ›å»ºæµå…‰å±‚
  */
  .site-card-wrapper a::after {
      content: "";
      position: absolute;
      inset: -1.5px; /* è¾¹æ¡†ç¨å¾®ç»†ä¸€ç‚¹ï¼Œæ›´ç²¾è‡´ */
      z-index: 50; 
      border-radius: 12px; /* åŒ¹é…å¡ç‰‡åœ†è§’ */
      padding: 1.5px;      /* è¾¹æ¡†ç²—ç»† */
      
      /* 
         â­ æ ¸å¿ƒä¿®æ”¹ï¼šå…‰æŸæ¸å˜æ„é€ 
         é€»è¾‘ï¼šé€æ˜ -> é›é’ -> ç´«è‰²é«˜äº® -> ç²‰è‰² -> é€æ˜
         è¿™ç§"ä¸­é—´äº®ã€ä¸¤å¤´ç©º"çš„æ„é€ ç§»åŠ¨èµ·æ¥æ‰åƒ"æµåŠ¨çš„å…‰"
      */
      background: linear-gradient(
          60deg,
          transparent 20%,
          rgba(79, 70, 229, 0) 35%,   /* Indigo é€æ˜ç«¯ */
          rgba(79, 70, 229, 1) 45%,   /* Indigo å®ä½“ */
          rgba(168, 85, 247, 1) 50%,  /* Purple é«˜äº®æ ¸å¿ƒ */
          rgba(236, 72, 153, 1) 55%,  /* Pink å®ä½“ */
          rgba(236, 72, 153, 0) 65%,  /* Pink é€æ˜ç«¯ */
          transparent 80%
      );
      
      /* æ‹‰å¤§èƒŒæ™¯ï¼Œè®©å…‰æŸåªå ç”»é¢çš„ä¸€å°éƒ¨åˆ†ï¼Œè¿™æ ·ç§»åŠ¨èµ·æ¥æ‰æœ‰ä½ç§»æ„Ÿ */
      background-size: 300% 300%; 
      
      /* é®ç½©é­”æ³•ï¼šä¸­é—´é•‚ç©º */
      -webkit-mask: 
         linear-gradient(#fff 0 0) content-box, 
         linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      
      /* é»˜è®¤éšè— */
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
      
      /* å¢åŠ ä¸€ç‚¹å‘å…‰æ™•æŸ“ï¼Œæ›´æœ‰è´¨æ„Ÿ */
      filter: drop-shadow(0 0 2px rgba(168, 85, 247, 0.5));
  }

  /* æ¿€æ´»çŠ¶æ€ï¼šæ˜¾ç¤ºå¹¶å¿«é€ŸæµåŠ¨ */
  .site-card-wrapper.flow-active a::after {
      opacity: 1;
      /* ç¼©çŸ­æ—¶é—´åˆ° 2sï¼Œè®©æµåŠ¨é€Ÿåº¦å˜å¿«ï¼Œæ›´æœ‰åŠ¨æ„Ÿ */
      animation: beamFlow 2.5s ease infinite; 
  }
  
  /* æš—è‰²æ¨¡å¼ä¸‹çš„å…‰æŸè°ƒæ•´ (å¯é€‰ï¼Œè®©å…‰åœ¨æ·±è‰²èƒŒæ™¯æ›´äº®) */
  :global(.dark) .site-card-wrapper a::after {
      filter: drop-shadow(0 0 3px rgba(168, 85, 247, 0.8));
  }
</style>