---
import { marked } from 'marked';
import { BookOpen, Info } from 'lucide-react';

const { title, name, url, icon, desc, detail, official_site, badge_list = [], guide_id } = Astro.props;
const displayTitle = title || name;
const base = '/my-nav';

const getDomain = (targetUrl) => {
  try {
    if (!targetUrl) return null;
    return new URL(targetUrl).hostname;
  } catch (e) {
    return null;
  }
};

const domain = getDomain(official_site) || getDomain(url);

const iconSources = {
  custom: icon,
  level1: domain ? `https://ico.kucat.cn/get.php?url=${domain}` : '',
  level2: domain ? `https://${domain}/favicon.ico` : '',
  level3: domain ? `https://www.google.com/s2/favicons?domain=${domain}&sz=128` : '', 
  fallback: `${base}/favicon.svg`
};

const defaultIcon = iconSources.custom || iconSources.level1 || iconSources.fallback;

let badges = [];
if (url && url.includes("github.com") && badge_list && badge_list.length > 0) {
  try {
    const pathParts = new URL(url).pathname.split('/').filter(Boolean);
    if (pathParts.length >= 2) {
      const owner = pathParts[0];
      const repo = pathParts[1];
      const styleParam = "?style=flat&color=blue"; 
      const badgeConfigs = {
        stars: { src: `https://img.shields.io/github/stars/${owner}/${repo}${styleParam}&label=Stars`, alt: "Stars" },
        version: { src: `https://img.shields.io/github/v/release/${owner}/${repo}${styleParam}&color=orange&label=Release`, alt: "Version" },
        license: { src: `https://img.shields.io/github/license/${owner}/${repo}${styleParam}&color=green&label=License`, alt: "License" },
        last_commit: { src: `https://img.shields.io/github/last-commit/${owner}/${repo}${styleParam}&color=slate&label=Updated`, alt: "Last Commit" }
      };
      badge_list.forEach(key => { if (badgeConfigs[key]) badges.push(badgeConfigs[key]); });
    }
  } catch(e) { console.error("Badge error", e); }
}

const rawMarkdown = detail || "";
const detailContent = marked.parse(rawMarkdown);
const cardId = `site-${domain ? domain.replace(/[^a-zA-Z0-9]/g, '-') : Math.random().toString(36).substr(2, 9)}`;
const hasPopup = !!(detail || (badges && badges.length > 0));
---

<div class="site-card-wrapper group relative w-full">
  <a href={url} target="_blank" 
     class={`flex items-center justify-between w-full h-full py-2 pl-2 pr-1 md:py-3 md:pl-3 md:pr-1.5 
            bg-white/60 dark:bg-gray-800/40 backdrop-blur-md rounded-xl 
            border border-white/50 dark:border-gray-700/30 shadow-sm 
            hover:shadow-xl hover:-translate-y-1 transition-all duration-300 relative overflow-hidden
            /* 修改：hover:shadow-blue-500 -> hover:shadow-brand-600 (悬浮阴影) */
            hover:shadow-brand-600/10 
            /* 修改：hover:border-blue-500 -> hover:border-brand-600 (悬浮边框) */
            hover:border-brand-600/50`}
  >
    <!-- 左侧内容区 -->
    <div class="flex items-center flex-1 min-w-0 mr-1">
        <div class="flex-shrink-0 mr-2 md:mr-3 w-8 h-8 md:w-10 md:h-10 rounded-lg bg-white dark:bg-gray-700 shadow-sm overflow-hidden flex items-center justify-center border border-gray-100 dark:border-gray-600">
          <img 
            id={cardId}
            src={defaultIcon} 
            data-domain={domain}
            data-sources={JSON.stringify(iconSources)}
            alt={displayTitle} 
            loading="lazy" 
            referrerpolicy="no-referrer"
            class="w-5 h-5 md:w-6 md:h-6 object-contain" 
            onload="handleIconLoad(this)"
            onerror="handleIconError(this)"
          />
        </div>
        
        <div class="flex-1 min-w-0">
          <h3 class="font-bold text-[13px] md:text-[14px] text-slate-800 dark:text-slate-100 truncate mb-0.5 text-left">{displayTitle}</h3>
          {desc && (
            <p class="text-[11px] md:text-[12px] text-slate-400 dark:text-slate-500 leading-tight line-clamp-2 overflow-hidden text-left break-words">
              {desc}
            </p>
          )}
        </div>
    </div>

    <!-- 右侧按钮区 -->
    <div class="flex flex-col gap-0.5 shrink-0 pl-0.5 border-l border-slate-100 dark:border-slate-700/50">
        {hasPopup && (
          /* 修改：hover:text-blue-500 -> hover:text-brand-600 (info按钮) */
          <button type="button" class="info-btn md:hidden p-1 rounded-md text-slate-400 hover:text-brand-600 transition-all flex items-center justify-center" title="详情">
            <Info size={14} />
          </button>
        )}
        {guide_id && (
          /* 修改：text-blue-400 -> text-brand-400, hover:bg-blue-500 -> hover:bg-brand-600 (教程按钮) */
          <button onclick={`event.preventDefault(); event.stopPropagation(); window.open('${base}/guide/${guide_id}', '_blank');`} class="p-1 rounded-md text-brand-400 hover:bg-brand-600 hover:text-white transition-all flex items-center justify-center" title="教程">
            <BookOpen size={14} strokeWidth={2.5} />
          </button>
        )}
    </div>
  </a>

  {/* 隐形数据源 (用于 Portal 浮窗) */}
  {hasPopup && (
    <div class="tooltip-source hidden">
      <div class="relative z-10">
        <!-- 修改：text-blue-600 -> text-brand-600 (浮窗标题) -->
        <div class="text-[11px] font-black text-brand-600 dark:text-brand-400 mb-2 flex items-center gap-2 uppercase tracking-widest">
          <!-- 修改：bg-blue-500 -> bg-brand-600 (标题左侧竖杠) -->
          <span class="w-1.5 h-3 bg-brand-600 rounded-sm"></span>详情
        </div>
        
        {badges.length > 0 && (
          <div class="flex flex-wrap gap-2 mb-2 border-b border-slate-100 dark:border-slate-800 pb-2">
            {badges.map(b => <img src={b.src} alt={b.alt} class="h-4 rounded-sm" />)}
          </div>
        )}
        
        {detail && (
          <div class="detail-markdown text-[13px] text-slate-700 dark:text-slate-300 leading-relaxed break-words" set:html={detailContent}></div>
        )}
      </div>
    </div>
  )}
</div>

<!-- ... 上面的 HTML 代码保持不变 ... -->

<script is:inline>
  // ---------------------------------------------------------
  // 1. 图标加载错误处理 (保持不变，功能正常)
  // ---------------------------------------------------------
  if (typeof window.handleIconLoad === 'undefined') {
    window.handleIconLoad = function(img) {
      const domain = img.getAttribute('data-domain');
      if (domain && domain !== 'null' && !img.src.includes('favicon.svg')) {
         try { localStorage.setItem('fav-' + domain, img.src); } catch(e){}
      }
    };
  }

  if (typeof window.handleIconError === 'undefined') {
    window.handleIconError = function(img) {
      try {
        const sources = JSON.parse(img.getAttribute('data-sources'));
        const currentSrc = img.src; 
        if (sources.custom && currentSrc === sources.custom) {
             img.src = sources.fallback;
             return;
        }
        if (currentSrc.includes('ico.kucat.cn')) img.src = sources.level2;
        else if (currentSrc.includes('/favicon.ico') && !currentSrc.includes('google.com')) img.src = sources.level3;
        else if (currentSrc.includes('google.com')) {
          img.src = sources.fallback;
          const domain = img.getAttribute('data-domain');
          if(domain) try{ localStorage.removeItem('fav-' + domain); } catch(e){}
        } else img.onerror = null;
      } catch (e) { img.onerror = null; }
    };
  }

  // ---------------------------------------------------------
  // 2. 缓存图标恢复 (优化：改为函数调用，方便生命周期管理)
  // ---------------------------------------------------------
  function restoreCachedIcons() {
    document.querySelectorAll('img[data-domain]').forEach(img => {
      const domain = img.getAttribute('data-domain');
      if(domain && domain !== 'null') {
          try {
            const cachedSrc = localStorage.getItem('fav-' + domain);
            if (cachedSrc && cachedSrc !== img.src && !cachedSrc.includes('favicon.svg')) {
              img.src = cachedSrc;
            }
          } catch(e){}
      }
    });
  }

  // ---------------------------------------------------------
  // 3. 全局 Tooltip 核心逻辑 (重构)
  // ---------------------------------------------------------
  (function() {
    // 状态变量
    let tooltipEl = null;
    let tooltipArrow = null;
    let activeCard = null;
    let hideTimer = null; // 新增：用于防抖

    // ----------------------------------
    // A. 创建 DOM 结构
    // ----------------------------------
    function createTooltipDOM() {
      // 如果已存在，直接重新获取引用
      const existing = document.getElementById('global-detail-tooltip');
      if (existing) {
        tooltipEl = existing;
        tooltipArrow = existing.querySelector('.tooltip-arrow-el');
        return;
      }

      tooltipEl = document.createElement('div');
      tooltipEl.id = 'global-detail-tooltip';
      // 保持你的样式不变
      tooltipEl.className = 'portal-popup fixed z-[9999] hidden w-72 p-4 bg-white dark:bg-[#1e2025] rounded-xl shadow-2xl border border-slate-200/60 dark:border-slate-700 pointer-events-none opacity-0 scale-95 transition-all duration-200 ease-out';
      
      tooltipArrow = document.createElement('div');
      tooltipArrow.className = 'tooltip-arrow-el absolute w-4 h-4 border-r border-b border-slate-200 dark:border-slate-700 rotate-45 bg-white dark:bg-[#1e2025] z-0';
      tooltipEl.appendChild(tooltipArrow);

      const contentEl = document.createElement('div');
      contentEl.id = 'tooltip-content';
      contentEl.className = 'relative z-10';
      tooltipEl.appendChild(contentEl);

      document.body.appendChild(tooltipEl);
    }

    // ----------------------------------
    // B. 显示/隐藏逻辑
    // ----------------------------------
    function showTooltip(wrapper) {
      if (!tooltipEl) createTooltipDOM(); // 双重保险
      
      // 清除之前的隐藏定时器
      if (hideTimer) {
        clearTimeout(hideTimer);
        hideTimer = null;
      }

      const source = wrapper.querySelector('.tooltip-source');
      if (!source) return;

      const contentBox = document.getElementById('tooltip-content');
      if (contentBox) contentBox.innerHTML = source.innerHTML;

      // 必须先移除 hidden 才能计算位置
      tooltipEl.classList.remove('hidden');
      
      // 强制重绘
      void tooltipEl.offsetWidth; 
      
      updatePosition(wrapper);
      
      // 动画进入
      requestAnimationFrame(() => {
        tooltipEl.classList.remove('opacity-0', 'scale-95');
        tooltipEl.classList.add('opacity-100', 'scale-100');
      });
    }

    function hideTooltip(immediate = false) {
      if (!tooltipEl) return;
      
      // 动画退出
      tooltipEl.classList.remove('opacity-100', 'scale-100');
      tooltipEl.classList.add('opacity-0', 'scale-95');

      if (immediate) {
         tooltipEl.classList.add('hidden');
      } else {
        // 避免多个 timer
        if (hideTimer) clearTimeout(hideTimer);
        
        hideTimer = setTimeout(() => {
          if (tooltipEl && tooltipEl.classList.contains('opacity-0')) {
            tooltipEl.classList.add('hidden');
          }
          hideTimer = null;
        }, 300);
      }
    }

    // ----------------------------------
    // C. 位置计算 (保持你的算法)
    // ----------------------------------
    function updatePosition(wrapper) {
      if (!tooltipEl) return;

      const rect = wrapper.getBoundingClientRect();
      const tooltipRect = tooltipEl.getBoundingClientRect();
      const padding = 12; 
      const arrowSize = 8; 

      const sidebarEl = document.getElementById('sidebar');
      const sidebarWidth = (sidebarEl && window.innerWidth >= 768) ? sidebarEl.getBoundingClientRect().width : 0;

      let top = rect.top - tooltipRect.height - padding;
      let isTop = true;
      
      if (top < padding) { 
        top = rect.bottom + padding;
        isTop = false;
      }

      tooltipEl.style.transformOrigin = isTop ? 'bottom center' : 'top center';

      let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);

      if (left + tooltipRect.width > window.innerWidth - padding) {
        left = window.innerWidth - tooltipRect.width - padding;
      }
      
      const minLeft = sidebarWidth + padding;
      if (left < minLeft) {
        left = minLeft;
      }

      let arrowLeft = rect.left + (rect.width / 2) - left - (arrowSize);
      // 限制箭头不要超出圆角
      arrowLeft = Math.max(12, Math.min(tooltipRect.width - 28, arrowLeft));

      tooltipEl.style.top = `${top}px`;
      tooltipEl.style.left = `${left}px`;
      
      tooltipArrow.style.left = `${arrowLeft}px`;
      if (isTop) {
        tooltipArrow.style.bottom = '-8px';
        tooltipArrow.style.top = 'auto';
        tooltipArrow.style.transform = 'rotate(45deg)'; 
      } else {
        tooltipArrow.style.top = '-8px';
        tooltipArrow.style.bottom = 'auto';
        tooltipArrow.style.transform = 'rotate(225deg)'; 
      }
    }

    // ----------------------------------
    // D. 事件处理器 (核心修复)
    // ----------------------------------
    
    // 鼠标移动处理函数 (单独提取，方便解绑)
    const handleMouseOver = (e) => {
      if (window.innerWidth < 768) return; 

      const wrapper = e.target.closest('.site-card-wrapper');
      
      if (wrapper) {
        // 如果移入了一个新卡片
        if (activeCard !== wrapper && wrapper.querySelector('.tooltip-source')) {
          activeCard = wrapper;
          showTooltip(wrapper);
        }
      } else {
        // 如果移到了空白处，且不是浮窗本身
        if (activeCard) {
          const isTooltip = e.target.closest('#global-detail-tooltip');
          if (!isTooltip) {
            activeCard = null;
            hideTooltip();
          }
        }
      }
    };

    const handleClick = (e) => {
      const btn = e.target.closest('.info-btn');
      // 移动端/小屏点击 Info 按钮
      if (btn) {
        e.preventDefault();
        e.stopPropagation();
        const wrapper = btn.closest('.site-card-wrapper');
        if (wrapper) {
           if (activeCard === wrapper && !tooltipEl.classList.contains('hidden')) {
             hideTooltip();
             activeCard = null;
           } else {
             activeCard = wrapper;
             showTooltip(wrapper);
           }
        }
        return;
      }

      // 点击空白处关闭
      if (tooltipEl && !tooltipEl.classList.contains('hidden')) {
        if (!e.target.closest('.site-card-wrapper') && !e.target.closest('#global-detail-tooltip')) {
          hideTooltip();
          activeCard = null;
        }
      }
    };
    
    // 滚动时关闭
    const handleScroll = () => {
      if (activeCard) {
        hideTooltip(true); // 立即关闭
        activeCard = null;
      }
    };

    // ----------------------------------
    // E. 初始化与清理
    // ----------------------------------
    function init() {
      // 1. 恢复图标
      restoreCachedIcons();
      
      // 2. 创建/重置 Tooltip DOM
      createTooltipDOM();
      
      // 3. 移除旧监听器 (防止重复绑定)
      document.body.removeEventListener('mouseover', handleMouseOver);
      document.body.removeEventListener('click', handleClick);
      window.removeEventListener('scroll', handleScroll, { capture: true });

      // 4. 绑定新监听器
      document.body.addEventListener('mouseover', handleMouseOver);
      document.body.addEventListener('click', handleClick);
      window.addEventListener('scroll', handleScroll, { capture: true, passive: true });
    }

    // 立即执行一次
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    // Astro 页面切换后重新执行
    document.addEventListener('astro:after-swap', init);
    document.addEventListener('astro:page-load', init); // 双重保险

  })();
</script>

<style is:global>
  /* 你的样式保持不变 */
  .detail-markdown p { margin-bottom: 0.5rem; }
  .detail-markdown p:last-child { margin-bottom: 0; }
  .detail-markdown ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.5rem; }
  .detail-markdown li { margin-bottom: 0.2rem; }
  .detail-markdown a { color: #3b82f6; text-decoration: underline; }
</style>

<style is:global>
  .detail-markdown p { margin-bottom: 0.5rem; }
  .detail-markdown p:last-child { margin-bottom: 0; }
  .detail-markdown ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.5rem; }
  .detail-markdown li { margin-bottom: 0.2rem; }
  .detail-markdown a { color: #3b82f6; text-decoration: underline; }
</style>