---
import { marked } from 'marked';
import { BookOpen, Info } from 'lucide-react';

const { title, name, url, icon, desc, detail, official_site, badge_list = [], guide_id } = Astro.props;
const displayTitle = title || name;
const base = import.meta.env.BASE_URL.replace(/\/$/, '');

const getDomain = (targetUrl) => {
  try {
    if (!targetUrl) return null;
    return new URL(targetUrl).hostname;
  } catch (e) {
    return null;
  }
};

const domain = getDomain(official_site) || getDomain(url);

const iconSources = {
  custom: icon,
  level1: domain ? `https://ico.kucat.cn/get.php?url=${domain}` : '',
  level2: domain ? `https://${domain}/favicon.ico` : '',
  level3: domain ? `https://www.google.com/s2/favicons?domain=${domain}&sz=128` : '', 
  fallback: `${base}/favicon.svg`
};

const defaultIcon = iconSources.custom || iconSources.level1 || iconSources.fallback;

let badges = [];
if (url && url.includes("github.com") && badge_list && badge_list.length > 0) {
  try {
    const pathParts = new URL(url).pathname.split('/').filter(Boolean);
    if (pathParts.length >= 2) {
      const owner = pathParts[0];
      const repo = pathParts[1];
      const styleParam = "?style=flat&color=blue"; 
      const badgeConfigs = {
        stars: { src: `https://img.shields.io/github/stars/${owner}/${repo}${styleParam}&label=Stars`, alt: "Stars" },
        version: { src: `https://img.shields.io/github/v/release/${owner}/${repo}${styleParam}&color=orange&label=Release`, alt: "Version" },
        license: { src: `https://img.shields.io/github/license/${owner}/${repo}${styleParam}&color=green&label=License`, alt: "License" },
        last_commit: { src: `https://img.shields.io/github/last-commit/${owner}/${repo}${styleParam}&color=slate&label=Updated`, alt: "Last Commit" }
      };
      badge_list.forEach(key => { if (badgeConfigs[key]) badges.push(badgeConfigs[key]); });
    }
  } catch(e) { console.error("Badge error", e); }
}

const rawMarkdown = detail || "";
const detailContent = marked.parse(rawMarkdown);
const cardId = `site-${domain ? domain.replace(/[^a-zA-Z0-9]/g, '-') : Math.random().toString(36).substr(2, 9)}`;
const hasPopup = !!(detail || (badges && badges.length > 0));
---

<div class="site-card-wrapper group relative w-full h-full">
  <a href={url} target="_blank" 
     class={`flex items-center justify-between w-full h-full py-3 pl-3 pr-2
            bg-white/70 dark:bg-gray-800/60 backdrop-blur-xl rounded-xl 
            border border-white/60 dark:border-gray-700/50 
            transition-all duration-300 ease-[cubic-bezier(0.25,0.8,0.25,1)]
            
            /* ÊÇ¨ÊµÆÊÄÅÔºöÂç°ÁâáÊï¥‰Ωì‰∏äÊµÆ + ËæπÊ°ÜÂÖâÊôï */
            hover:-translate-y-1.5 
            hover:bg-white/95 dark:hover:bg-gray-800/95
            hover:border-brand-500/30 dark:hover:border-brand-400/30
            hover:shadow-xl hover:shadow-brand-600/10 
            hover:ring-1 hover:ring-brand-500/20
            
            relative overflow-hidden`}
  >
    <!-- Â∑¶‰æßÂÜÖÂÆπÂå∫ -->
    <div class="flex items-center flex-1 min-w-0 mr-1">
        
        <!-- 
           ‚ú® ÂõæÊ†áÂÆπÂô® (Icon Container)
           ËøôÈáåÂÅö‰∫ÜÁõ∏ÂØπÂÆö‰ΩçÔºåÁî®Êù•ÂåÖË£π‰∏§‰∏™ÂõæÊ†áÔºà‰∏Ä‰∏™ÊòæÁ§∫Ôºå‰∏Ä‰∏™ÂÅöÂÖâÂΩ±Ôºâ
        -->
        <div class="relative flex-shrink-0 mr-3 w-10 h-10 flex items-center justify-center">
          
          <!-- 
             üåü 1. Âä®ÊÄÅÂÖâÂΩ±Â±Ç (The Glow Layer) 
             - ÁªùÂØπÂÆö‰ΩçÂú®Â∫ïÂ±Ç
             - blur-lg: Â§ßÊ®°Á≥ä
             - opacity-0 -> group-hover:opacity-50: ÊÇ¨ÊµÆÊó∂ÊòæÁé∞
             - saturate-200: Â¢ûÂä†Ëâ≤ÂΩ©È•±ÂíåÂ∫¶ÔºåËÆ©ÂÖâÊõ¥È≤úËâ≥
             - scale-125: ÊØîÂéüÂõæÂ§ß‰∏ÄÂúàÔºåÂΩ¢ÊàêÊâ©Êï£ÊïàÊûú
          -->
          <div class="absolute inset-0 z-0 transition-all duration-500 ease-out opacity-0 group-hover:opacity-50 group-hover:scale-150 filter blur-lg saturate-150 pointer-events-none">
             <img 
                src={defaultIcon}
                alt=""
                class="w-full h-full object-contain"
                aria-hidden="true"
             />
          </div>

          <!-- 
             üñºÔ∏è 2. ÂÆû‰ΩìÂõæÊ†áÂ±Ç (The Main Icon)
             - z-10: ‰øùËØÅÂú®ÂÖâÂΩ±‰∏äÈù¢
             - bg-white: ÁªôÂõæÊ†áÂä†‰∏™Â∫ïÂ∫ßÔºåÈò≤Ê≠¢ÂÖâÂΩ±ÈÄèÂà∞Â∫ïÈÉ®ÊòæÂæóËÑè
          -->
          <div class="relative z-10 w-10 h-10 rounded-lg bg-white/80 dark:bg-gray-700/90 shadow-sm flex items-center justify-center border border-gray-100 dark:border-gray-600 group-hover:scale-105 group-hover:shadow-md transition-all duration-300">
            <img 
              id={cardId}
              src={defaultIcon} 
              data-domain={domain}
              data-sources={JSON.stringify(iconSources)}
              alt={displayTitle} 
              loading="lazy" 
              referrerpolicy="no-referrer"
              class="w-6 h-6 object-contain transition-transform duration-300" 
              onload="handleIconLoad(this)"
              onerror="handleIconError(this)"
            />
          </div>
        </div>
        
        <div class="flex-1 min-w-0 relative z-20">
          <h3 class="font-bold text-[14px] text-slate-800 dark:text-slate-100 truncate mb-0.5 text-left group-hover:text-brand-600 transition-colors duration-200">
            {displayTitle}
          </h3>
          {desc && (
            <p class="text-[12px] text-slate-400 dark:text-slate-500 leading-tight line-clamp-1 overflow-hidden text-left break-words opacity-80 group-hover:opacity-100 transition-opacity">
              {desc}
            </p>
          )}
        </div>
    </div>

    <!-- Âè≥‰æßÊåâÈíÆÂå∫ -->
    <div class={`flex flex-col gap-1 shrink-0 pl-1 border-l border-slate-100 dark:border-slate-700/50 
                 transition-all duration-200 z-20
                 opacity-100 translate-x-0
                 md:opacity-0 md:-translate-x-2 
                 md:group-hover:opacity-100 md:group-hover:translate-x-0`}>
        
        {hasPopup && (
          <button type="button" class="info-btn md:hidden p-1 rounded-md text-slate-400 hover:text-brand-600 hover:bg-brand-50 dark:hover:bg-gray-700 transition-all flex items-center justify-center" title="ËØ¶ÊÉÖ">
            <Info size={14} />
          </button>
        )}
        
        {guide_id && (
          <button onclick={`event.preventDefault(); event.stopPropagation(); window.open('${base}/guide/${guide_id}', '_blank');`} class="p-1 rounded-md text-brand-400 hover:bg-brand-600 hover:text-white transition-all flex items-center justify-center" title="ÊïôÁ®ã">
            <BookOpen size={14} strokeWidth={2.5} />
          </button>
        )}
    </div>
  </a>

  {/* Portal ÊµÆÁ™óÊï∞ÊçÆÊ∫ê */}
  {hasPopup && (
    <div class="tooltip-source hidden">
      <div class="relative z-10">
        <div class="text-[11px] font-black text-brand-600 dark:text-brand-400 mb-2 flex items-center gap-2 uppercase tracking-widest">
          <span class="w-1.5 h-3 bg-brand-600 rounded-sm"></span>ËØ¶ÊÉÖ
        </div>
        
        {badges.length > 0 && (
          <div class="flex flex-wrap gap-2 mb-2 border-b border-slate-100 dark:border-slate-800 pb-2">
            {badges.map(b => <img src={b.src} alt={b.alt} class="h-4 rounded-sm" />)}
          </div>
        )}
        
        {detail && (
          <div class="detail-markdown text-[13px] text-slate-700 dark:text-slate-300 leading-relaxed break-words" set:html={detailContent}></div>
        )}
      </div>
    </div>
  )}
</div>

<script is:inline>
  if (typeof window.handleIconLoad === 'undefined') {
    window.handleIconLoad = function(img) {
      const domain = img.getAttribute('data-domain');
      if (domain && domain !== 'null' && !img.src.includes('favicon.svg')) {
         try { localStorage.setItem('fav-' + domain, img.src); } catch(e){}
      }
    };
  }

  if (typeof window.handleIconError === 'undefined') {
    window.handleIconError = function(img) {
      try {
        const sources = JSON.parse(img.getAttribute('data-sources'));
        const currentSrc = img.src; 
        if (sources.custom && currentSrc === sources.custom) {
             img.src = sources.fallback;
             return;
        }
        if (currentSrc.includes('ico.kucat.cn')) img.src = sources.level2;
        else if (currentSrc.includes('/favicon.ico') && !currentSrc.includes('google.com')) img.src = sources.level3;
        else if (currentSrc.includes('google.com')) {
          img.src = sources.fallback;
          const domain = img.getAttribute('data-domain');
          if(domain) try{ localStorage.removeItem('fav-' + domain); } catch(e){}
        } else img.onerror = null;
      } catch (e) { img.onerror = null; }
    };
  }

  function restoreCachedIcons() {
    document.querySelectorAll('img[data-domain]').forEach(img => {
      const domain = img.getAttribute('data-domain');
      if(domain && domain !== 'null') {
          try {
            const cachedSrc = localStorage.getItem('fav-' + domain);
            if (cachedSrc && cachedSrc !== img.src && !cachedSrc.includes('favicon.svg')) {
              img.src = cachedSrc;
            }
          } catch(e){}
      }
    });
  }

  (function() {
    let tooltipEl = null;
    let tooltipArrow = null;
    let activeCard = null;
    let hideTimer = null;

    function createTooltipDOM() {
      const existing = document.getElementById('global-detail-tooltip');
      if (existing) {
        tooltipEl = existing;
        tooltipArrow = existing.querySelector('.tooltip-arrow-el');
        return;
      }

      tooltipEl = document.createElement('div');
      tooltipEl.id = 'global-detail-tooltip';
      tooltipEl.className = 'portal-popup fixed z-[9999] hidden w-72 p-4 bg-white dark:bg-[#1e2025] rounded-xl shadow-2xl border border-slate-200/60 dark:border-slate-700 pointer-events-none opacity-0 scale-95 transition-all duration-200 ease-out';
      
      tooltipArrow = document.createElement('div');
      tooltipArrow.className = 'tooltip-arrow-el absolute w-4 h-4 border-r border-b border-slate-200 dark:border-slate-700 rotate-45 bg-white dark:bg-[#1e2025] z-0';
      tooltipEl.appendChild(tooltipArrow);

      const contentEl = document.createElement('div');
      contentEl.id = 'tooltip-content';
      contentEl.className = 'relative z-10';
      tooltipEl.appendChild(contentEl);

      document.body.appendChild(tooltipEl);
    }

    function showTooltip(wrapper) {
      if (!tooltipEl) createTooltipDOM();
      
      if (hideTimer) {
        clearTimeout(hideTimer);
        hideTimer = null;
      }

      const source = wrapper.querySelector('.tooltip-source');
      if (!source) return;

      const contentBox = document.getElementById('tooltip-content');
      if (contentBox) contentBox.innerHTML = source.innerHTML;

      tooltipEl.classList.remove('hidden');
      void tooltipEl.offsetWidth; 
      
      updatePosition(wrapper);
      
      requestAnimationFrame(() => {
        tooltipEl.classList.remove('opacity-0', 'scale-95');
        tooltipEl.classList.add('opacity-100', 'scale-100');
      });
    }

    function hideTooltip(immediate = false) {
      if (!tooltipEl) return;
      
      tooltipEl.classList.remove('opacity-100', 'scale-100');
      tooltipEl.classList.add('opacity-0', 'scale-95');

      if (immediate) {
         tooltipEl.classList.add('hidden');
      } else {
        if (hideTimer) clearTimeout(hideTimer);
        hideTimer = setTimeout(() => {
          if (tooltipEl && tooltipEl.classList.contains('opacity-0')) {
            tooltipEl.classList.add('hidden');
          }
          hideTimer = null;
        }, 300);
      }
    }

    function updatePosition(wrapper) {
      if (!tooltipEl) return;

      const rect = wrapper.getBoundingClientRect();
      const tooltipRect = tooltipEl.getBoundingClientRect();
      const padding = 12; 
      const arrowSize = 8; 

      const sidebarEl = document.getElementById('sidebar');
      const sidebarWidth = (sidebarEl && window.innerWidth >= 768) ? sidebarEl.getBoundingClientRect().width : 0;

      let top = rect.top - tooltipRect.height - padding;
      let isTop = true;
      
      if (top < padding) { 
        top = rect.bottom + padding;
        isTop = false;
      }

      tooltipEl.style.transformOrigin = isTop ? 'bottom center' : 'top center';

      let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);

      if (left + tooltipRect.width > window.innerWidth - padding) {
        left = window.innerWidth - tooltipRect.width - padding;
      }
      
      const minLeft = sidebarWidth + padding;
      if (left < minLeft) {
        left = minLeft;
      }

      let arrowLeft = rect.left + (rect.width / 2) - left - (arrowSize);
      arrowLeft = Math.max(12, Math.min(tooltipRect.width - 28, arrowLeft));

      tooltipEl.style.top = `${top}px`;
      tooltipEl.style.left = `${left}px`;
      
      tooltipArrow.style.left = `${arrowLeft}px`;
      if (isTop) {
        tooltipArrow.style.bottom = '-8px';
        tooltipArrow.style.top = 'auto';
        tooltipArrow.style.transform = 'rotate(45deg)'; 
      } else {
        tooltipArrow.style.top = '-8px';
        tooltipArrow.style.bottom = 'auto';
        tooltipArrow.style.transform = 'rotate(225deg)'; 
      }
    }

    const handleMouseOver = (e) => {
      if (window.innerWidth < 768) return; 

      const wrapper = e.target.closest('.site-card-wrapper');
      
      if (wrapper) {
        if (activeCard !== wrapper && wrapper.querySelector('.tooltip-source')) {
          activeCard = wrapper;
          showTooltip(wrapper);
        }
      } else {
        if (activeCard) {
          const isTooltip = e.target.closest('#global-detail-tooltip');
          if (!isTooltip) {
            activeCard = null;
            hideTooltip();
          }
        }
      }
    };

    const handleClick = (e) => {
      const btn = e.target.closest('.info-btn');
      if (btn) {
        e.preventDefault();
        e.stopPropagation();
        const wrapper = btn.closest('.site-card-wrapper');
        if (wrapper) {
           if (activeCard === wrapper && !tooltipEl.classList.contains('hidden')) {
             hideTooltip();
             activeCard = null;
           } else {
             activeCard = wrapper;
             showTooltip(wrapper);
           }
        }
        return;
      }

      if (tooltipEl && !tooltipEl.classList.contains('hidden')) {
        if (!e.target.closest('.site-card-wrapper') && !e.target.closest('#global-detail-tooltip')) {
          hideTooltip();
          activeCard = null;
        }
      }
    };
    
    const handleScroll = () => {
      if (activeCard) {
        hideTooltip(true);
        activeCard = null;
      }
    };

    function init() {
      restoreCachedIcons();
      createTooltipDOM();
      
      document.body.removeEventListener('mouseover', handleMouseOver);
      document.body.removeEventListener('click', handleClick);
      window.removeEventListener('scroll', handleScroll, { capture: true });

      document.body.addEventListener('mouseover', handleMouseOver);
      document.body.addEventListener('click', handleClick);
      window.addEventListener('scroll', handleScroll, { capture: true, passive: true });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    document.addEventListener('astro:after-swap', init);
    document.addEventListener('astro:page-load', init);

  })();
</script>

<style is:global>
  .detail-markdown p { margin-bottom: 0.5rem; }
  .detail-markdown p:last-child { margin-bottom: 0; }
  .detail-markdown ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.5rem; }
  .detail-markdown li { margin-bottom: 0.2rem; }
  .detail-markdown a { color: #3b82f6; text-decoration: underline; }
</style>