---
import { LayoutDashboard, Star, Code, Palette, ChevronRight } from 'lucide-react';

const { navResources, currentId, siteConfig } = Astro.props;
const base = import.meta.env.BASE_URL.replace(/\/$/, '');
const Icons = { Star, Code, Palette, LayoutDashboard };
---

<!-- 
  ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ 1ï¼šCSS ç±»å
  å°† transition-transform æ”¹ä¸º transition-all
  è¿™æ · PC ç«¯ä¿®æ”¹ margin-left æ—¶ä¹Ÿä¼šæœ‰ä¸æ»‘çš„åŠ¨ç”»ï¼Œä¸å³ä¾§å†…å®¹åŒºå®Œå…¨åŒæ­¥ã€‚
-->
<aside 
  id="sidebar"

  style={{ width: 'var(--sidebar-width, 17rem)' }}
  class="fixed top-0 left-0 z-50 h-[100dvh] bg-white/90 dark:bg-gray-900/90 backdrop-blur-2xl shadow-2xl md:shadow-none flex flex-col border-r border-slate-200/50 dark:border-slate-800/50 overflow-x-hidden will-change-transform transform -translate-x-full md:translate-x-0 transition-all duration-300 ease-[cubic-bezier(0.4,0,0.2,1)]"
>
  {/* Logo åŒºåŸŸ */}
  <div class="h-16 px-6 flex-shrink-0 flex items-center gap-3 border-b border-slate-100/50 dark:border-slate-800/50 overflow-hidden">
    <div class="w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center shadow-lg shadow-brand-500/30 text-white flex-shrink-0">
      <img src={`${base}/favicon.svg`} class="w-5 h-5 invert brightness-0" alt="Logo" />
    </div>
    <span class="text-base font-black tracking-tight text-slate-800 dark:text-slate-100 truncate block">
      {siteConfig.title}
    </span>
  </div>

  {/* èœå•åŒºåŸŸ */}
  <nav id="sidebar-nav" class="flex-1 overflow-y-auto p-3 space-y-1 custom-scrollbar scrollbar-stable">
    {navResources.map((page) => {
      const isActivePage = page.id === currentId;
      const PageIcon = Icons[page.icon] || LayoutDashboard;

      return (
        <div class="group/page mb-1">
          <a href={`${base}/${page.id}`} 
             class={`flex items-center gap-3 px-3 py-2 rounded-xl transition-all duration-200 font-bold overflow-hidden text-sidebar-link
             ${isActivePage 
               ? 'bg-brand-600 text-white shadow-md shadow-brand-500/20' 
               : 'text-slate-500 hover:bg-slate-100 dark:hover:bg-gray-800 hover:text-slate-900 dark:hover:text-slate-200'
             }`}
          >
            <PageIcon size={18} className="flex-shrink-0" />
            <span class="flex-1 truncate">{page.name}</span>
          </a>

          {isActivePage && page.groups && (
            <div class="pl-0 mt-2 space-y-3 animate-in slide-in-from-left-2 duration-300">
              {page.groups.map((group, groupIdx) => (
                <div class="relative pl-3">
                  <button 
                    onclick={`window.scrollToSection('group-${groupIdx}'); window.closeSidebarMobile();`}
                    class="w-full flex items-center gap-2 px-3 py-1 mb-1 font-extrabold text-slate-400 dark:text-slate-500 tracking-wider hover:text-brand-600 transition-colors text-left text-sidebar-group overflow-hidden"
                    title={group.name}
                  >
                    <span class="truncate block w-full">{group.name}</span>
                  </button>

                  <div class="absolute left-[18px] top-6 bottom-2 w-[1px] bg-slate-200 dark:bg-slate-800 rounded-full"></div>

                  <div class="space-y-0.5 pl-2">
                    {group.categories.map((cat, catIdx) => {
                      const hasTabs = cat.tabs && cat.tabs.length > 0;
                      const uniqueId = `${groupIdx}-${catIdx}`;
                      return (
                        <div class="relative group/cat sidebar-item-container">
                          <button 
                            class={`sidebar-cat-btn w-full flex items-center justify-between px-2 py-1.5 rounded-lg font-medium text-sidebar-cat text-slate-600 dark:text-slate-400 hover:text-brand-600 hover:bg-slate-50 dark:hover:bg-brand-900/30 transition-colors z-10 relative overflow-hidden ${hasTabs ? 'has-sub-menu' : ''}`}
                            data-target={`sidebar-sub-${uniqueId}`}
                            onclick={!hasTabs ? `window.scrollToSection('cat-${uniqueId}'); window.closeSidebarMobile();` : ''}
                            title={cat.name}
                          >
                            <span class="flex items-center gap-2.5 truncate max-w-[85%]">
                              <span class="w-1 h-[1px] bg-slate-300 dark:bg-slate-700 group-hover/cat:bg-brand-400 transition-colors flex-shrink-0"></span>
                              <span class="truncate">{cat.name}</span>
                            </span>
                            {hasTabs && (
                              <ChevronRight size={14} className="arrow-icon text-slate-300 transition-transform duration-300 flex-shrink-0" />
                            )}
                          </button>
                          
                          {/* æµ®çª— Tooltip å†…å®¹ */}
                          {hasTabs && (
                            <div class="sidebar-tooltip-source hidden">
                               <div class="flex items-center gap-2 mb-3 px-1 border-b border-slate-100 dark:border-slate-700/50 pb-2">
                                  <span class="w-1 h-3 bg-brand-600 rounded-full"></span>
                                  <span class="text-xs font-black text-slate-700 dark:text-slate-200 uppercase tracking-widest">{cat.name}</span>
                               </div>
                               <div class="flex flex-wrap gap-2">
                                 {cat.tabs.map((tab, tabIdx) => (
                                   <button onclick={`window.scrollToTab('${uniqueId}', ${tabIdx});`} class="flex items-center px-3 py-1.5 text-xs font-bold rounded-full transition-all duration-200 whitespace-nowrap bg-slate-100 dark:bg-gray-800 text-slate-500 dark:text-slate-400 hover:text-brand-600 hover:bg-white dark:hover:bg-gray-700 hover:shadow-md hover:scale-105 border border-transparent hover:border-brand-100 dark:hover:border-brand-900/30">
                                     {tab.tabName}
                                   </button>
                                 ))}
                               </div>
                            </div>
                          )}

                          {/* æŠ˜å æ‰‹é£ç´ */}
                          {hasTabs && (
                            <div id={`sidebar-sub-${uniqueId}`} class="grid grid-rows-[0fr] transition-[grid-template-rows] duration-300 ease-in-out">
                              <div class="overflow-hidden">
                                <div class="pl-4 ml-1 border-l border-slate-100 dark:border-slate-800/50 space-y-0.5 pt-0.5 pb-1">
                                  {cat.tabs.map((tab, tabIdx) => (
                                    <button class="w-full text-left px-2 py-1 text-sidebar-tab text-slate-500 hover:text-brand-600 hover:bg-slate-50 dark:hover:bg-gray-800 transition-colors rounded-md truncate block" onclick={`window.scrollToTab('${uniqueId}', ${tabIdx}); window.closeSidebarMobile();`} title={tab.tabName}>{tab.tabName}</button>
                                  ))}
                                </div>
                              </div>
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    })}
  </nav>
  
<!-- åº•éƒ¨é¡µè„šï¼šå¼ºåˆ¶æ¨ªå‘æ’åˆ— -->
  <div class="h-10 px-4 mt-auto border-t border-slate-100/50 dark:border-slate-800/50 shrink-0 bg-white/90 dark:bg-gray-900/90 backdrop-blur-md safe-area-bottom overflow-hidden flex flex-row items-center justify-between gap-2">
    
    {/* å·¦ä¾§ï¼šç‰ˆæƒä¿¡æ¯ (æ·»åŠ  truncate é˜²æ­¢é¡¶é£å³è¾¹) */}
    <span class="text-[10px] text-slate-400 font-medium truncate">
      Â© {new Date().getFullYear()} {siteConfig.author}
    </span>

    {/* å³ä¾§ï¼šæ›´æ–°æ—¥å¿— (ä¸æ¢è¡Œ) */}
    <a href="/changelog" class="shrink-0 flex items-center gap-1.5 text-[10px] font-bold text-slate-500 hover:text-brand-600 transition-colors py-1 px-2 rounded-md hover:bg-slate-50 dark:hover:bg-gray-800 group/log">
      <span class="relative flex h-1.5 w-1.5">
        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-brand-400 opacity-75 group-hover/log:opacity-100"></span>
        <span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-brand-500"></span>
      </span>
      <span>æ›´æ–°è®°å½•</span>
    </a>

  </div>
</aside>

<style is:global>
  /* 
    ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ 2ï¼šé®ç½©å±‚æè‡´ä¼˜åŒ– 
    åˆ©ç”¨ transition-delay è§£å†³"æœªåŠ è½½å®Œç‚¹å‡»å¡æ­»"å’Œ"æ…¢ä¸€æ­¥"çš„é—®é¢˜ã€‚
  */
  #sidebar-overlay {
    position: fixed; inset: 0; z-index: 40;
    background-color: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(2px);
    
    /* é»˜è®¤çŠ¶æ€ï¼šéšè— */
    opacity: 0;
    visibility: hidden;
    
    /* 
       å…³é”®æŠ€å·§ï¼š
       opacity å˜ 0 æ—¶ï¼Œvisibility å»¶è¿Ÿ 0.3s å†å˜ hiddenã€‚
       è¿™æ ·ä¿è¯æ·¡å‡ºåŠ¨ç”»èƒ½å®Œæ•´æ’­æ”¾ï¼Œä¸ä¼šç¬é—´æ¶ˆå¤±ã€‚
    */
    transition: opacity 0.3s ease, visibility 0s linear 0.3s;
    
    touch-action: none; 
  }

  /* æ¿€æ´»çŠ¶æ€ */
  #sidebar-overlay.active {
    opacity: 1;
    visibility: visible;
    
    /* 
       æ˜¾ç¤ºæ—¶ï¼šç«‹å³æ˜¾ç¤º visibilityï¼Œç„¶å opacity å¼€å§‹æ·¡å…¥ã€‚
       ä¸éœ€è¦ delayã€‚
    */
    transition: opacity 0.3s ease, visibility 0s linear 0s;
  }
</style>

<script is:inline>
(function() {
  // =======================================================
  // 1. ä¾§è¾¹æ  & é®ç½©æ§åˆ¶é€»è¾‘
  // =======================================================
  
  // æ‰‹æœºç«¯å¼€å…³ (åŸå­åŒ–æ“ä½œï¼Œç»ä¸å¡æ­»)
  window.toggleSidebarMobile = () => {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    if (!sidebar) return;

    // æ ¹æ® CSS ç±»ååˆ¤æ–­å½“å‰çŠ¶æ€
    const isOpen = sidebar.classList.contains('translate-x-0');

    if (isOpen) {
      // å…³
      sidebar.classList.remove('translate-x-0');
      sidebar.classList.add('-translate-x-full');
      if (overlay) overlay.classList.remove('active'); // CSS ä¼šè‡ªåŠ¨å¤„ç†åŠ¨ç”»
      document.body.style.overflow = '';
    } else {
      // å¼€
      sidebar.style.marginLeft = ''; // ç¡®ä¿æ²¡æœ‰ PC ç«¯é—ç•™çš„æ ·å¼
      sidebar.classList.remove('-translate-x-full');
      sidebar.classList.add('translate-x-0');
      if (overlay) overlay.classList.add('active'); // ç«‹å³è§¦å‘ CSS åŠ¨ç”»
      document.body.style.overflow = 'hidden';
    }
  };

  // å¼ºåˆ¶å…³é—­ (ä¾›è·³è½¬é“¾æ¥ä½¿ç”¨)
  window.closeSidebarMobile = () => {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    
    if (sidebar) {
      sidebar.style.marginLeft = '';
      sidebar.classList.remove('translate-x-0');
      sidebar.classList.add('-translate-x-full');
    }
    if (overlay) overlay.classList.remove('active');
    document.body.style.overflow = '';
  };

  // =======================================================
  // 2. æ‚¬æµ®èœå•é€»è¾‘ (Tooltip) - Fixed
  // =======================================================
  let tooltipEl = null; let hideTimer = null; let currentBtn = null;

  function createTooltipDOM() {
    if (document.getElementById('sidebar-float-menu')) { tooltipEl = document.getElementById('sidebar-float-menu'); return; }
    tooltipEl = document.createElement('div');
    tooltipEl.id = 'sidebar-float-menu';
    tooltipEl.style.cssText = `position: fixed; z-index: 9999; display: none; min-width: 180px; max-width: 260px; padding: 16px; background: rgba(255, 255, 255, 0.95); border-radius: 16px; box-shadow: 0 10px 40px -10px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(16px); opacity: 0; transform: translateX(-10px); transition: opacity 0.2s ease, transform 0.2s ease; pointer-events: auto;`;
    if (document.documentElement.classList.contains('dark')) { tooltipEl.style.backgroundColor = 'rgba(17, 24, 39, 0.95)'; tooltipEl.style.borderColor = 'rgba(51, 65, 85, 0.5)'; }
    document.body.appendChild(tooltipEl);
    tooltipEl.addEventListener('mouseenter', () => { if (hideTimer) clearTimeout(hideTimer); });
    tooltipEl.addEventListener('mouseleave', () => { hideTooltip(); });
  }

  function showTooltip(btn, content) {
    if (window.innerWidth < 768) return;
    createTooltipDOM();
    if (hideTimer) clearTimeout(hideTimer);
    if (currentBtn === btn && tooltipEl.style.display === 'block') return;
    tooltipEl.innerHTML = content;
    const rect = btn.getBoundingClientRect();
    const top = Math.max(10, Math.min(window.innerHeight - 200, rect.top));
    const left = rect.right + 10;
    tooltipEl.style.top = `${top}px`;
    tooltipEl.style.left = `${left}px`;
    tooltipEl.style.display = 'block';
    void tooltipEl.offsetWidth;
    tooltipEl.style.opacity = '1';
    tooltipEl.style.transform = 'translateX(0)';
    currentBtn = btn;
  }
  function hideTooltipImmediate() { if (!tooltipEl) return; if (hideTimer) clearTimeout(hideTimer); tooltipEl.style.display = 'none'; tooltipEl.style.opacity = '0'; currentBtn = null; }
  function hideTooltip() { if (!tooltipEl) return; hideTimer = setTimeout(() => { tooltipEl.style.opacity = '0'; tooltipEl.style.transform = 'translateX(-10px)'; setTimeout(() => { if (tooltipEl.style.opacity === '0') { tooltipEl.style.display = 'none'; currentBtn = null; } }, 200); }, 100); }

  // =======================================================
  // 3. äº‹ä»¶ç»‘å®š & åˆå§‹åŒ–
  // =======================================================
  function bindHoverEvents() {
    const btns = document.querySelectorAll('.has-sub-menu');
    btns.forEach(btn => {
      if (btn._hasBindHover) return;
      btn._hasBindHover = true;
      const wrapper = btn.closest('.sidebar-item-container');
      const source = wrapper ? wrapper.querySelector('.sidebar-tooltip-source') : null;
      if (source) {
        btn.addEventListener('mouseenter', () => { showTooltip(btn, source.innerHTML); });
        btn.addEventListener('mouseleave', () => { hideTooltip(); });
      }
    });
  }

  function handleCollapse(e) {
    const btn = e.target.closest('.has-sub-menu');
    if (!btn) return;
    e.preventDefault(); e.stopPropagation();
    const targetId = btn.getAttribute('data-target');
    const subMenu = document.getElementById(targetId);
    const arrow = btn.querySelector('svg');
    if (subMenu) {
      if (subMenu.classList.contains('grid-rows-[0fr]')) {
        subMenu.classList.remove('grid-rows-[0fr]'); subMenu.classList.add('grid-rows-[1fr]');
        if (arrow) arrow.style.transform = 'rotate(90deg)';
      } else {
        subMenu.classList.remove('grid-rows-[1fr]'); subMenu.classList.add('grid-rows-[0fr]');
        if (arrow) arrow.style.transform = 'rotate(0deg)';
      }
    }
  }

  function init() {
    createTooltipDOM();
    bindHoverEvents();
    
    // ç»‘å®šé®ç½©ç‚¹å‡» (ç¡®ä¿ DOM å­˜åœ¨åå†ç»‘å®š)
    const overlay = document.getElementById('sidebar-overlay');
    if (overlay) {
        overlay.onclick = window.closeSidebarMobile;
    }
    
    document.removeEventListener('click', handleCollapse);
    document.addEventListener('click', handleCollapse);

    const sidebarNav = document.getElementById('sidebar-nav');
    if (sidebarNav) sidebarNav.addEventListener('scroll', () => hideTooltipImmediate(), { passive: true });
    
    // è‡ªæ£€ï¼šæ‰‹æœºç«¯å¼ºåˆ¶ä¿®æ­£çŠ¶æ€ï¼Œé˜²æ­¢æ ·å¼æ®‹ç•™
    if (window.innerWidth < 768) {
       const sb = document.getElementById('sidebar');
       if (sb) {
           sb.style.marginLeft = '';
           // ç¡®ä¿é»˜è®¤éšè—
           if (!sb.classList.contains('translate-x-0')) {
               sb.classList.add('-translate-x-full');
           }
       }
    }
  }
  
  // ç«‹å³æ‰§è¡Œï¼Œä¸ç­‰å¾… Load
  init();
  document.addEventListener('astro:after-swap', init);
  document.addEventListener('astro:page-load', init);

})();

// è¾…åŠ©å‡½æ•°
window.scrollToSection = (id) => {
  const el = document.getElementById(id);
  if (el) {
    const offsetTop = el.getBoundingClientRect().top + window.pageYOffset - 80;
    window.scrollTo({ top: offsetTop, behavior: "smooth" });
    window.closeSidebarMobile();
  }
};
window.scrollToTab = (id, idx) => {
  const menu = document.getElementById('sidebar-float-menu');
  if(menu) menu.style.display = 'none';
  window.scrollToSection(`cat-${id}`);
  setTimeout(() => {
     const g = document.getElementById(`cat-${id}`);
     if(g) { 
       const b = g.querySelectorAll('.tab-btn')[idx]; 
       if(b) b.click();
       const catBtn = g.querySelector('.sidebar-cat-btn');
       if(catBtn && catBtn.classList.contains('has-sub-menu')) {
          const arrow = catBtn.querySelector('svg');
          const targetId = catBtn.getAttribute('data-target');
          const subMenu = document.getElementById(targetId);
          if (subMenu && subMenu.classList.contains('grid-rows-[0fr]')) {
            subMenu.classList.remove('grid-rows-[0fr]'); subMenu.classList.add('grid-rows-[1fr]');
            if(arrow) arrow.style.transform = 'rotate(90deg)';
          }
       }
     }
  }, 300);
};
</script>