---
import { LayoutDashboard, Star, Code, Palette, ChevronRight } from 'lucide-react';

const { navResources, currentId, siteConfig } = Astro.props;
const base = '/my-nav';

const Icons = { Star, Code, Palette, LayoutDashboard };
---

<!-- 
  ðŸ”´ ä¿®å¤é‡ç‚¹ï¼š
  1. class æ”¹å›ž "fixed inset-y-0 ..." (åˆ é™¤äº† h-screen å’Œ top-0) -> è§£å†³æ‰‹æœºåº•éƒ¨é®æŒ¡/é—ªçƒ
  2. å®½åº¦æ”¹ä¸º "w-[var(--sidebar-width)]" -> å¼ºåˆ¶è¯»å– CSS å˜é‡ï¼Œä¸å†ä¾èµ– tailwind.config é…ç½®ï¼Œå½»åº•è§£å†³â€œå¤ªå®½â€é—®é¢˜
-->
<aside 
  id="sidebar"
  class="fixed inset-y-0 left-0 z-50 w-[var(--sidebar-width)] bg-white/90 dark:bg-gray-900/90 backdrop-blur-2xl shadow-[10px_0_40px_rgba(0,0,0,0.04)] dark:shadow-none flex flex-col transition-transform duration-300 -translate-x-full md:translate-x-0"
>
  <!-- Logo -->
  <div class="p-6 flex-shrink-0 flex items-center gap-3 border-b border-slate-100/50 dark:border-slate-800/50">
    <!-- é¢œè‰²ä½¿ç”¨ brand-600 -->
    <div class="w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-500/30 text-white">
      <img src={`${base}/favicon.svg`} class="w-5 h-5 invert brightness-0" alt="Logo" />
    </div>
    <span class="text-base font-black tracking-tight text-slate-800 dark:text-slate-100">
      {siteConfig.title}
    </span>
  </div>

  <!-- èœå•åŒºåŸŸ -->
  <nav class="flex-1 overflow-y-auto p-3 space-y-1 scrollbar-hide">
    {navResources.map((page) => {
      const isActivePage = page.id === currentId;
      const PageIcon = Icons[page.icon] || LayoutDashboard;

      return (
        <div class="group/page mb-1">
          <a href={`${base}/${page.id}`} 
             class={`flex items-center gap-3 px-3 py-2 rounded-xl transition-all duration-200 font-bold
             ${isActivePage 
               ? 'bg-brand-600 text-white shadow-md shadow-blue-500/20' 
               : 'text-slate-500 hover:bg-sidebar-hover dark:hover:bg-gray-800 hover:text-slate-900 dark:hover:text-slate-200'
             }`}
          >
            <PageIcon size={16} />
            <span class="text-[13px] flex-1">{page.name}</span>
          </a>

          {isActivePage && page.groups && (
            <div class="pl-0 mt-2 space-y-3 animate-in slide-in-from-left-2 duration-300">
              {page.groups.map((group, groupIdx) => (
                <div class="relative pl-3">
                  <button 
                    onclick={`window.scrollToSection('group-${groupIdx}'); window.closeSidebarMobile();`}
                    class="w-full flex items-center gap-2 px-3 py-1 mb-1 text-[11px] font-extrabold text-slate-400 dark:text-slate-500 uppercase tracking-widest hover:text-brand-600 transition-colors text-left"
                  >
                    {group.name}
                  </button>

                  <div class="absolute left-[18px] top-6 bottom-2 w-[1px] bg-slate-200 dark:bg-slate-800 rounded-full"></div>

                  <div class="space-y-0.5 pl-2">
                    {group.categories.map((cat, catIdx) => {
                      const hasTabs = cat.tabs && cat.tabs.length > 0;
                      const uniqueId = `${groupIdx}-${catIdx}`;
                      return (
                        <div class="relative">
                          <button 
                            class="sidebar-cat-btn w-full flex items-center justify-between px-2 py-1.5 rounded-lg text-[12px] font-medium text-slate-600 dark:text-slate-400 hover:text-brand-600 hover:bg-sidebar-sub-hover dark:hover:bg-blue-900/30 transition-colors group z-10 relative"
                            data-target={`sidebar-sub-${uniqueId}`}
                            onclick={!hasTabs ? `window.scrollToSection('cat-${uniqueId}'); window.closeSidebarMobile();` : ''}
                          >
                            <span class="flex items-center gap-2.5 truncate">
                              <span class="w-1 h-[1px] bg-slate-300 dark:bg-slate-700 group-hover:bg-blue-400 transition-colors"></span>
                              {cat.name}
                            </span>
                            {hasTabs && (
                              <ChevronRight size={12} class="arrow-icon text-slate-300 transition-transform duration-300" />
                            )}
                          </button>

                          {hasTabs && (
                            <div id={`sidebar-sub-${uniqueId}`} class="grid grid-rows-[0fr] transition-[grid-template-rows] duration-300 ease-in-out">
                              <div class="overflow-hidden">
                                <div class="pl-4 ml-1 border-l border-slate-100 dark:border-slate-800/50 space-y-0.5 pt-0.5 pb-1">
                                  {cat.tabs.map((tab, tabIdx) => (
                                    <button 
                                      class="w-full text-left px-2 py-1 text-[11px] text-slate-500 hover:text-brand-600 hover:bg-sidebar-sub-hover dark:hover:bg-gray-800 transition-colors rounded-md"
                                      onclick={`window.scrollToTab('${uniqueId}', ${tabIdx}); window.closeSidebarMobile();`}
                                    >
                                      {tab.tabName}
                                    </button>
                                  ))}
                                </div>
                              </div>
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    })}
  </nav>
  
  <!-- åº•éƒ¨ä¿ç•™ pb-24 é˜²æ­¢æ‰‹æœºé®æŒ¡ -->
  <div class="p-4 pb-24 md:pb-4 border-t border-slate-100/50 dark:border-slate-800/50 text-center">
    <span class="text-[10px] text-slate-400 font-medium">By {siteConfig.author}</span>
  </div>
</aside>

<script is:inline>
  function initSidebarInteraction() {
    const catBtns = document.querySelectorAll('.sidebar-cat-btn');
    catBtns.forEach(btn => {
      const newBtn = btn.cloneNode(true);
      btn.parentNode.replaceChild(newBtn, btn);
      newBtn.addEventListener('click', (e) => {
        const targetId = newBtn.getAttribute('data-target');
        const arrow = newBtn.querySelector('.arrow-icon');
        if (!targetId) return;
        const subMenu = document.getElementById(targetId);
        if (subMenu) {
          if (subMenu.classList.contains('grid-rows-[0fr]')) {
            subMenu.classList.remove('grid-rows-[0fr]'); subMenu.classList.add('grid-rows-[1fr]');
            if(arrow) arrow.style.transform = 'rotate(90deg)';
          } else {
            subMenu.classList.remove('grid-rows-[1fr]'); subMenu.classList.add('grid-rows-[0fr]');
            if(arrow) arrow.style.transform = 'rotate(0deg)';
          }
        }
      });
    });
  }
  
  window.scrollToSection = (id) => {
    const el = document.getElementById(id);
    if (el) window.scrollTo({ top: el.getBoundingClientRect().top + window.pageYOffset - 80, behavior: "smooth" });
  };
  window.scrollToTab = (id, idx) => {
    window.scrollToSection(`cat-${id}`);
    setTimeout(() => {
       const g = document.getElementById(`cat-${id}`);
       if(g) { const b = g.querySelectorAll('.tab-btn')[idx]; if(b) b.click(); }
    }, 300);
  };
  
  window.closeSidebarMobile = () => {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    if (window.innerWidth < 768 && sidebar && overlay) { 
        sidebar.classList.add('-translate-x-full');
        overlay.classList.add('hidden');
    }
  };

  initSidebarInteraction();
  document.addEventListener('astro:after-swap', initSidebarInteraction);
</script>