---
import { Palette, Sun, Moon, Monitor, Upload, X, Check } from 'lucide-react';
---

<div class="relative z-50" id="theme-picker-container">
  <!-- è§¦å‘æŒ‰é’® -->
  <button 
    id="theme-btn"
    class="p-2.5 bg-white/80 dark:bg-gray-800/80 backdrop-blur-md rounded-xl text-slate-500 hover:text-brand-600 hover:bg-slate-100 dark:hover:bg-gray-700 transition-all shadow-sm border border-slate-200/50 dark:border-gray-700/50"
    title="ä¸»é¢˜è®¾ç½®"
  >
    <Palette size={20} />
  </button>

  <!-- è®¾ç½®é¢æ¿ -->
  <div 
    id="theme-panel"
    class="absolute right-0 top-14 w-72 bg-white/95 dark:bg-gray-900/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-white/50 dark:border-gray-700/50 p-4 transform transition-all duration-200 origin-top-right scale-95 opacity-0 invisible select-none"
  >
    <!-- 1. ä¸»é¢˜æ¨¡å¼ -->
    <div class="flex items-center justify-between mb-4">
      <span class="text-sm font-bold text-slate-700 dark:text-slate-200 border-l-4 border-brand-600 pl-2">ä¸»é¢˜æ¨¡å¼</span>
      <div class="flex bg-slate-100 dark:bg-gray-800 p-1 rounded-lg">
        <button class="mode-btn p-1.5 rounded-md transition-all text-slate-500 hover:text-brand-600" data-mode="light" title="æµ…è‰²"><Sun size={16} /></button>
        <button class="mode-btn p-1.5 rounded-md transition-all text-slate-500 hover:text-brand-600" data-mode="dark" title="æ·±è‰²"><Moon size={16} /></button>
        <button class="mode-btn p-1.5 rounded-md transition-all text-slate-500 hover:text-brand-600" data-mode="auto" title="è·Ÿéšç³»ç»Ÿ"><Monitor size={16} /></button>
      </div>
    </div>

    <!-- 2. ä¸»é¢˜è‰²å½© -->
    <div class="mb-4">
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm font-bold text-slate-700 dark:text-slate-200 border-l-4 border-brand-600 pl-2">ä¸»é¢˜è‰²å½©</span>
        <div class="flex items-center gap-2 bg-slate-100 dark:bg-gray-800 rounded-lg p-1 pr-2 border border-slate-200 dark:border-gray-700">
           <input type="color" id="custom-color-picker" class="w-6 h-6 rounded cursor-pointer border-0 p-0 bg-transparent" />
           <input type="text" id="hex-input" class="w-16 bg-transparent text-xs font-mono text-slate-600 dark:text-slate-300 outline-none uppercase" placeholder="#HEX" maxlength="7" />
        </div>
      </div>
      <div class="flex flex-wrap gap-2 mb-2" id="preset-colors"></div>
    </div>

    <hr class="border-slate-100 dark:border-gray-700/50 my-3" />

    <!-- 3. èƒŒæ™¯è®¾ç½® -->
    <div class="mb-4">
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm font-bold text-slate-700 dark:text-slate-200 border-l-4 border-brand-600 pl-2">èƒŒæ™¯å›¾ç‰‡</span>
        <label for="bg-upload" class="cursor-pointer text-xs bg-slate-100 dark:bg-gray-800 hover:bg-brand-50 text-brand-600 px-2 py-1 rounded-md transition-colors flex items-center gap-1 border border-slate-200 dark:border-gray-700">
          <Upload size={12} /> ä¸Šä¼ 
        </label>
        <input type="file" id="bg-upload" accept="image/*" class="hidden" />
      </div>

      <div id="bg-preview-area" class="hidden relative w-full h-24 rounded-lg overflow-hidden border border-slate-200 dark:border-gray-700 mb-3 group bg-slate-100 dark:bg-gray-800">
        <img id="bg-preview-img" class="w-full h-full object-cover" />
        <button id="bg-remove-btn" class="absolute top-1 right-1 p-1 bg-black/50 text-white rounded-full hover:bg-red-500 transition-colors opacity-0 group-hover:opacity-100" title="ç§»é™¤èƒŒæ™¯">
          <X size={14} />
        </button>
      </div>

      <div class="flex items-center justify-between gap-3">
        <span class="text-xs font-medium text-slate-500 shrink-0">æ¨¡ç³Šåº¦</span>
        <input type="range" id="blur-range" min="0" max="50" step="1" class="w-full h-1.5 bg-slate-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer accent-brand-600" />
        <span id="blur-val" class="text-xs font-mono text-slate-400 w-6 text-right">0px</span>
      </div>
    </div>
  </div>
</div>

<!-- 
  äº¤äº’è„šæœ¬ä¼˜åŒ–ç‰ˆï¼š
  1. ç«‹å³æ‰§è¡Œï¼šä¸å†ç­‰å¾…é¡µé¢èµ„æºåŠ è½½ï¼ŒDOM å‡ºæ¥å°±èƒ½ç‚¹ã€‚
  2. å…¼å®¹ Astroï¼šä¿ç•™é¡µé¢åˆ‡æ¢åçš„é‡ç½®é€»è¾‘ã€‚
-->
<script is:inline>
(function() {
  // === IndexedDB å·¥å…· (ä¿æŒä¸å˜) ===
  const DB_NAME = 'MyNavDB';
  const STORE_NAME = 'settings';
  let dbPromise = null;

  function getDB() {
    if (!dbPromise) {
      dbPromise = new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, 1);
        request.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME);
        };
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }
    return dbPromise;
  }
  async function saveImage(blob) { const db = await getDB(); const tx = db.transaction(STORE_NAME, 'readwrite'); tx.objectStore(STORE_NAME).put(blob, 'bg-image'); }
  async function getImage() { const db = await getDB(); return new Promise(r => { const tx = db.transaction(STORE_NAME, 'readonly'); tx.objectStore(STORE_NAME).get('bg-image').onsuccess = e => r(e.target.result); }); }
  async function removeImage() { const db = await getDB(); const tx = db.transaction(STORE_NAME, 'readwrite'); tx.objectStore(STORE_NAME).delete('bg-image'); }

  // === ç‹¬ç«‹æ‰§è¡Œï¼šå¼‚æ­¥åŠ è½½èƒŒæ™¯å›¾ ===
  (async function loadBg() {
    try {
      const blob = await getImage();
      if (blob) {
        const url = URL.createObjectURL(blob);
        // è¿™é‡ŒåŠ ä¸ªåˆ¤æ–­ï¼Œé˜²æ­¢è¦†ç›–äº†å¤´éƒ¨è„šæœ¬å·²ç»è®¾ç½®çš„æ ·å¼å¯¼è‡´é—ªçƒ
        const current = document.documentElement.style.getPropertyValue('--bg-image');
        if (!current || current === 'none') {
            document.documentElement.style.setProperty('--bg-image', `url(${url})`);
        }
        
        // å°è¯•æ›´æ–° UI
        const area = document.getElementById('bg-preview-area');
        const img = document.getElementById('bg-preview-img');
        if (area && img) { area.classList.remove('hidden'); img.src = url; }
      }
    } catch(e) {}
  })();

  // === åˆå§‹åŒ–äº¤äº’é€»è¾‘ (æ ¸å¿ƒå‡½æ•°) ===
  function initThemePicker() {
    // console.log('[ThemePicker] Init Interactive...'); 
    const container = document.getElementById('theme-picker-container');
    const btn = document.getElementById('theme-btn');
    const panel = document.getElementById('theme-panel');
    
    // å¦‚æœè¿˜æ²¡æ¸²æŸ“å‡ºæ¥ï¼Œç›´æ¥é€€å‡º (ä¿æŠ¤æªæ–½)
    if (!btn || !panel) return;

    // --- é¢æ¿å¼€å…³ ---
    // ä½¿ç”¨ onclick è¦†ç›–ç»‘å®šï¼Œé˜²æ­¢é‡å¤ç»‘å®šå¯¼è‡´ç‚¹ä¸€ä¸‹å¼€ã€é©¬ä¸Šåˆå…³
    let isPanelOpen = false;
    function togglePanel(forceState) {
      isPanelOpen = forceState !== undefined ? forceState : !isPanelOpen;
      panel.classList.toggle('invisible', !isPanelOpen);
      panel.classList.toggle('opacity-0', !isPanelOpen);
      panel.classList.toggle('scale-95', !isPanelOpen);
      panel.classList.toggle('visible', isPanelOpen);
      panel.classList.toggle('opacity-100', isPanelOpen);
      panel.classList.toggle('scale-100', isPanelOpen);
    }
    
    btn.onclick = (e) => { 
      e.stopPropagation(); 
      togglePanel(); 
    };

    const closeHandler = (e) => { 
      if (isPanelOpen && !container.contains(e.target)) togglePanel(false); 
    };
    // å…¨å±€äº‹ä»¶è¿˜æ˜¯å¾—å°å¿ƒé‡å¤ï¼Œå…ˆç§»é™¤å†æ·»åŠ 
    document.removeEventListener('click', closeHandler);
    document.addEventListener('click', closeHandler);

    // --- é¢œè‰²è®¾ç½® ---
    const colorPicker = document.getElementById('custom-color-picker');
    const hexInput = document.getElementById('hex-input');
    const savedColor = localStorage.getItem('brand-color') || '#4F46E5';
    
    // æ¢å¤è¾“å…¥æ¡†æ˜¾ç¤º
    if(colorPicker) colorPicker.value = savedColor;
    if(hexInput) hexInput.value = savedColor;

    function hexToRgb(hex) { const r = parseInt(hex.slice(1, 3), 16); const g = parseInt(hex.slice(3, 5), 16); const b = parseInt(hex.slice(5, 7), 16); return `${r} ${g} ${b}`; }
    function setBrandColor(hex) {
      if (!/^#[0-9A-F]{6}$/i.test(hex)) return;
      const rgb = hexToRgb(hex);
      document.documentElement.style.setProperty('--color-brand-rgb', rgb);
      localStorage.setItem('brand-color', hex);
      if(colorPicker) colorPicker.value = hex;
      if(hexInput) hexInput.value = hex;
      updatePresetUI(hex);
    }
    
    function updatePresetUI(hex) {
      const presets = document.querySelectorAll('.preset-color-btn');
      if(presets) {
          presets.forEach(btn => {
            btn.innerHTML = btn.dataset.color.toLowerCase() === hex.toLowerCase() ? 'âœ”' : '';
            btn.style.color = 'white';
            btn.style.fontWeight = 'bold';
          });
      }
    }
    
    if(colorPicker) colorPicker.oninput = e => setBrandColor(e.target.value);
    if(hexInput) hexInput.oninput = e => { let v=e.target.value; if(!v.startsWith('#')) v='#'+v; if(v.length===7) setBrandColor(v); };

    // ç”Ÿæˆé¢„è®¾æŒ‰é’®
    const presets = ['#4F46E5', '#DB2777', '#7C3AED', '#2563EB', '#059669', '#DC2626', '#D97706', '#000000'];
    const presetContainer = document.getElementById('preset-colors');
    // æ£€æŸ¥æ˜¯å¦å·²ç»ç”Ÿæˆè¿‡ï¼Œé˜²æ­¢ Astro é‡å¤æ‰§è¡Œå¯¼è‡´ç”Ÿæˆä¸¤å€æŒ‰é’®
    if (presetContainer && presetContainer.children.length === 0) {
        presets.forEach(color => {
            const b = document.createElement('button');
            b.className = 'preset-color-btn w-6 h-6 rounded-full flex items-center justify-center transition-transform hover:scale-110 border border-black/10 text-[10px]';
            b.style.backgroundColor = color;
            b.dataset.color = color;
            b.onclick = () => setBrandColor(color);
            presetContainer.appendChild(b);
        });
        updatePresetUI(savedColor);
    }

    // --- å­—ä½“åˆ‡æ¢é€»è¾‘ (ä½ ä¹‹å‰éœ€æ±‚çš„) ---
    const fontBtns = document.querySelectorAll('.font-btn');
    const fontStacks = {
      sans: { heading: 'system-ui, -apple-system, sans-serif', body: 'system-ui, -apple-system, sans-serif', article: 'system-ui, -apple-system, sans-serif' },
      serif: { heading: '"Songti SC", "SimSun", "Times New Roman", serif', body: '"Songti SC", "SimSun", serif', article: '"Songti SC", "SimSun", serif' },
      mono: { heading: 'ui-monospace, "Cascadia Code", "Fira Code", monospace', body: 'ui-monospace, "Cascadia Code", monospace', article: 'ui-monospace, "Cascadia Code", monospace' },
      round: { heading: '"Yuanti SC", "YouYuan", "Rounded Mplus 1c", sans-serif', body: '"Yuanti SC", "YouYuan", sans-serif', article: '"Yuanti SC", "YouYuan", sans-serif' }
    };
    function setFont(type) {
      const stack = fontStacks[type];
      if (!stack) return;
      const root = document.documentElement;
      root.style.setProperty('--font-heading', stack.heading);
      root.style.setProperty('--font-body', stack.body);
      root.style.setProperty('--font-article', stack.article);
      localStorage.setItem('site-font', type);
      fontBtns.forEach(b => {
        if (b.dataset.font === type) {
          b.classList.add('border-brand-500', 'bg-brand-50', 'dark:bg-brand-900/20', 'text-brand-600');
          b.classList.remove('border-slate-200', 'dark:border-gray-700', 'text-slate-600', 'dark:text-slate-300');
        } else {
          b.classList.remove('border-brand-500', 'bg-brand-50', 'dark:bg-brand-900/20', 'text-brand-600');
          b.classList.add('border-slate-200', 'dark:border-gray-700', 'text-slate-600', 'dark:text-slate-300');
        }
      });
    }
    fontBtns.forEach(b => b.onclick = () => setFont(b.dataset.font));
    // æ¢å¤å­—ä½“UIçŠ¶æ€
    setFont(localStorage.getItem('site-font') || 'sans');


    // --- æ¨¡å¼åˆ‡æ¢ ---
    const modeBtns = document.querySelectorAll('.mode-btn');
    function updateModeUI(t) {
        modeBtns.forEach(b => {
            const active = b.dataset.mode === t;
            b.classList.toggle('bg-white', active);
            b.classList.toggle('dark:bg-gray-600', active);
            b.classList.toggle('text-brand-600', active);
            b.classList.toggle('text-slate-500', !active);
        });
    }
    const savedTheme = localStorage.getItem('theme') || 'auto';
    updateModeUI(savedTheme);
    
    function setTheme(t) {
      const root = document.documentElement;
      if (t === 'auto') {
          localStorage.removeItem('theme');
          if (window.matchMedia('(prefers-color-scheme: dark)').matches) root.classList.add('dark'); else root.classList.remove('dark');
      } else {
          root.classList.toggle('dark', t === 'dark');
          localStorage.setItem('theme', t);
      }
      updateModeUI(t);
    }
    modeBtns.forEach(b => b.onclick = () => setTheme(b.dataset.mode));

    // --- æ¨¡ç³Šä¸èƒŒæ™¯ ---
    const blurRange = document.getElementById('blur-range');
    const blurVal = document.getElementById('blur-val');
    const savedBlur = localStorage.getItem('bg-blur') || 0;
    if(blurRange) blurRange.value = savedBlur;
    if(blurVal) blurVal.textContent = `${savedBlur}px`;

    function setBlur(px) {
      document.documentElement.style.setProperty('--bg-blur', `${px}px`);
      if(blurVal) blurVal.textContent = `${px}px`;
      localStorage.setItem('bg-blur', px);
    }
    if(blurRange) blurRange.oninput = (e) => setBlur(e.target.value);

    // èƒŒæ™¯ä¸Šä¼ é€»è¾‘
    const bgUpload = document.getElementById('bg-upload');
    const bgPreviewArea = document.getElementById('bg-preview-area');
    const bgPreviewImg = document.getElementById('bg-preview-img');
    const bgRemoveBtn = document.getElementById('bg-remove-btn');

    // æ£€æŸ¥æ˜¯å¦æœ‰èƒŒæ™¯å›¾å¹¶æ˜¾ç¤ºé¢„è§ˆ (ä» CSS å˜é‡åæ¨)
    const currentBg = getComputedStyle(document.documentElement).getPropertyValue('--bg-image').trim();
    if(currentBg && currentBg !== 'none') {
        const url = currentBg.slice(4, -1).replace(/["']/g, ""); 
        if(bgPreviewArea) bgPreviewArea.classList.remove('hidden');
        if(bgPreviewImg) bgPreviewImg.src = url;
    }

    if(bgUpload) {
        bgUpload.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const url = URL.createObjectURL(file);
            document.documentElement.style.setProperty('--bg-image', `url(${url})`);
            if(bgPreviewArea) bgPreviewArea.classList.remove('hidden');
            if(bgPreviewImg) bgPreviewImg.src = url;
            try { await saveImage(file); } catch (err) {}
        };
    }
    if(bgRemoveBtn) {
        bgRemoveBtn.onclick = async () => {
            document.documentElement.style.setProperty('--bg-image', 'none');
            if(bgPreviewArea) bgPreviewArea.classList.add('hidden');
            await removeImage();
            if(bgUpload) bgUpload.value = '';
        };
    }
  }

  // ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ï¼šç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼
  // æ­¤æ—¶ Script æ ‡ç­¾åœ¨ HTML åº•éƒ¨ï¼Œä¸Šé¢çš„ DOM å…ƒç´ å·²ç»è§£æï¼Œå¯ä»¥ç»‘å®šäº‹ä»¶äº†
  // å³ä½¿ç½‘ç»œè¿˜åœ¨è½¬åœˆåŠ è½½å›¾ç‰‡ï¼ŒæŒ‰é’®ç‚¹å‡»äº‹ä»¶å·²ç»ç”Ÿæ•ˆã€‚
  initThemePicker();

  // ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ï¼šç›‘å¬é¡µé¢åˆ‡æ¢
  // Astro åˆ‡æ¢é¡µé¢å (View Transitions)ï¼ŒDOM å˜äº†ï¼Œå¿…é¡»é‡æ–°ç»‘å®š
  document.addEventListener('astro:after-swap', initThemePicker);

})();
</script>

<!-- 
  æ ¸å¿ƒä¼˜åŒ– 2ï¼šäº¤äº’è„šæœ¬
  è¿™é‡Œçš„ä»£ç ä¾ç„¶ç­‰å¾… astro:page-loadï¼Œè´Ÿè´£ç»‘å®šæŒ‰é’®äº‹ä»¶ã€è¯»å– IndexedDB ç­‰è€—æ—¶æ“ä½œ
-->
<script is:inline>
(function() {
  // === IndexedDB å·¥å…· ===
  const DB_NAME = 'MyNavDB';
  const STORE_NAME = 'settings';
  let dbPromise = null;

  function getDB() {
    if (!dbPromise) {
      dbPromise = new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, 1);
        request.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME);
        };
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }
    return dbPromise;
  }

  // ... (IndexedDB çš„ save/get/remove å‡½æ•°ä¿æŒä¸å˜ï¼Œä¸ºäº†èŠ‚çœç¯‡å¹…çœç•¥ï¼Œè¯·ä¿ç•™ä¹‹å‰çš„ä»£ç ) ...
  async function saveImage(blob) { const db = await getDB(); const tx = db.transaction(STORE_NAME, 'readwrite'); tx.objectStore(STORE_NAME).put(blob, 'bg-image'); }
  async function getImage() { const db = await getDB(); return new Promise(r => { const tx = db.transaction(STORE_NAME, 'readonly'); tx.objectStore(STORE_NAME).get('bg-image').onsuccess = e => r(e.target.result); }); }
  async function removeImage() { const db = await getDB(); const tx = db.transaction(STORE_NAME, 'readwrite'); tx.objectStore(STORE_NAME).delete('bg-image'); }

  // === ç‹¬ç«‹æ‰§è¡Œï¼šå¼‚æ­¥åŠ è½½èƒŒæ™¯å›¾ (ä¸é˜»å¡é¡µé¢) ===
  // æŠŠå®ƒæ”¾åœ¨ initThemePicker å¤–é¢ï¼Œè®©å®ƒå°½æ—©å¼€å§‹è·‘
  (async function loadBg() {
    try {
      const blob = await getImage();
      if (blob) {
        const url = URL.createObjectURL(blob);
        document.documentElement.style.setProperty('--bg-image', `url(${url})`);
        // å°è¯•æ›´æ–° UI (å¦‚æœ DOM å·²ç»å¥½äº†)
        const area = document.getElementById('bg-preview-area');
        const img = document.getElementById('bg-preview-img');
        if (area && img) { area.classList.remove('hidden'); img.src = url; }
      }
    } catch(e) {}
  })();

  // === åˆå§‹åŒ–äº¤äº’é€»è¾‘ ===
  function initThemePicker() {
    const container = document.getElementById('theme-picker-container');
    const btn = document.getElementById('theme-btn');
    const panel = document.getElementById('theme-panel');
    if (!btn || !panel) return;

    // é¢æ¿å¼€å…³
    let isPanelOpen = false;
    function togglePanel(forceState) {
      isPanelOpen = forceState !== undefined ? forceState : !isPanelOpen;
      panel.classList.toggle('invisible', !isPanelOpen);
      panel.classList.toggle('opacity-0', !isPanelOpen);
      panel.classList.toggle('scale-95', !isPanelOpen);
      panel.classList.toggle('visible', isPanelOpen);
      panel.classList.toggle('opacity-100', isPanelOpen);
      panel.classList.toggle('scale-100', isPanelOpen);
    }
    btn.onclick = (e) => { e.stopPropagation(); togglePanel(); };
    const closeHandler = (e) => { if (isPanelOpen && !container.contains(e.target)) togglePanel(false); };
    document.removeEventListener('click', closeHandler);
    document.addEventListener('click', closeHandler);

    // é¢œè‰²è®¾ç½®
    const colorPicker = document.getElementById('custom-color-picker');
    const hexInput = document.getElementById('hex-input');
    const savedColor = localStorage.getItem('brand-color') || '#4F46E5';
    
    // åˆå§‹åŒ–è¾“å…¥æ¡†å€¼
    if(colorPicker) colorPicker.value = savedColor;
    if(hexInput) hexInput.value = savedColor;

    function hexToRgb(hex) { const r = parseInt(hex.slice(1, 3), 16); const g = parseInt(hex.slice(3, 5), 16); const b = parseInt(hex.slice(5, 7), 16); return `${r} ${g} ${b}`; }
    function setBrandColor(hex) {
      if (!/^#[0-9A-F]{6}$/i.test(hex)) return;
      const rgb = hexToRgb(hex);
      document.documentElement.style.setProperty('--color-brand-rgb', rgb);
      localStorage.setItem('brand-color', hex);
      if(colorPicker) colorPicker.value = hex;
      if(hexInput) hexInput.value = hex;
      updatePresetUI(hex);
    }
    
    function updatePresetUI(hex) {
      document.querySelectorAll('.preset-color-btn').forEach(btn => {
        btn.innerHTML = btn.dataset.color.toLowerCase() === hex.toLowerCase() ? 'âœ”' : '';
        btn.style.color = 'white';
        btn.style.fontWeight = 'bold';
      });
    }
    
    if(colorPicker) colorPicker.oninput = e => setBrandColor(e.target.value);
    if(hexInput) hexInput.oninput = e => { let v=e.target.value; if(!v.startsWith('#')) v='#'+v; if(v.length===7) setBrandColor(v); };

    // é¢„è®¾é¢œè‰²æŒ‰é’®
    const presets = ['#4F46E5', '#DB2777', '#7C3AED', '#2563EB', '#059669', '#DC2626', '#D97706', '#000000'];
    const presetContainer = document.getElementById('preset-colors');
    if (presetContainer && presetContainer.children.length === 0) {
        presets.forEach(color => {
            const b = document.createElement('button');
            b.className = 'preset-color-btn w-6 h-6 rounded-full flex items-center justify-center transition-transform hover:scale-110 border border-black/10 text-[10px]';
            b.style.backgroundColor = color;
            b.dataset.color = color;
            b.onclick = () => setBrandColor(color);
            presetContainer.appendChild(b);
        });
        updatePresetUI(savedColor);
    }

    // æ¨¡å¼åˆ‡æ¢ UI æ›´æ–°
    const modeBtns = document.querySelectorAll('.mode-btn');
    const savedTheme = localStorage.getItem('theme') || 'auto';
    function updateModeUI(t) {
        modeBtns.forEach(b => {
            const active = b.dataset.mode === t;
            b.classList.toggle('bg-white', active);
            b.classList.toggle('dark:bg-gray-600', active);
            b.classList.toggle('text-brand-600', active);
            b.classList.toggle('text-slate-500', !active);
        });
    }
    updateModeUI(savedTheme);
    
    function setTheme(t) {
      const root = document.documentElement;
      if (t === 'auto') {
          localStorage.removeItem('theme');
          if (window.matchMedia('(prefers-color-scheme: dark)').matches) root.classList.add('dark'); else root.classList.remove('dark');
      } else {
          root.classList.toggle('dark', t === 'dark');
          localStorage.setItem('theme', t);
      }
      updateModeUI(t);
    }
    modeBtns.forEach(b => b.onclick = () => setTheme(b.dataset.mode));

    // æ¨¡ç³Šä¸èƒŒæ™¯
    const blurRange = document.getElementById('blur-range');
    const blurVal = document.getElementById('blur-val');
    const savedBlur = localStorage.getItem('bg-blur') || 0;
    if(blurRange) blurRange.value = savedBlur;
    if(blurVal) blurVal.textContent = `${savedBlur}px`;

    function setBlur(px) {
      document.documentElement.style.setProperty('--bg-blur', `${px}px`);
      if(blurVal) blurVal.textContent = `${px}px`;
      localStorage.setItem('bg-blur', px);
    }
    if(blurRange) blurRange.oninput = (e) => setBlur(e.target.value);

    // èƒŒæ™¯ä¸Šä¼ é€»è¾‘
    const bgUpload = document.getElementById('bg-upload');
    const bgPreviewArea = document.getElementById('bg-preview-area');
    const bgPreviewImg = document.getElementById('bg-preview-img');
    const bgRemoveBtn = document.getElementById('bg-remove-btn');

    // æ£€æŸ¥æ˜¯å¦æœ‰èƒŒæ™¯å›¾å¹¶æ˜¾ç¤ºé¢„è§ˆ
    const currentBg = getComputedStyle(document.documentElement).getPropertyValue('--bg-image').trim();
    if(currentBg && currentBg !== 'none') {
        const url = currentBg.slice(4, -1).replace(/["']/g, ""); // æå– url(...)
        if(bgPreviewArea) bgPreviewArea.classList.remove('hidden');
        if(bgPreviewImg) bgPreviewImg.src = url;
    }

    if(bgUpload) {
        bgUpload.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const url = URL.createObjectURL(file);
            document.documentElement.style.setProperty('--bg-image', `url(${url})`);
            if(bgPreviewArea) bgPreviewArea.classList.remove('hidden');
            if(bgPreviewImg) bgPreviewImg.src = url;
            try { await saveImage(file); } catch (err) {}
        };
    }
    if(bgRemoveBtn) {
        bgRemoveBtn.onclick = async () => {
            document.documentElement.style.setProperty('--bg-image', 'none');
            if(bgPreviewArea) bgPreviewArea.classList.add('hidden');
            await removeImage();
            if(bgUpload) bgUpload.value = '';
        };
    }
  }

  document.addEventListener('astro:page-load', initThemePicker);
})();
</script>

<style>
  input[type=range] { accent-color: rgb(var(--color-brand-rgb)); }
</style>