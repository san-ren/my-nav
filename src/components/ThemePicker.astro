---
import { Palette, Sun, Moon, Monitor, Upload, X, Download } from 'lucide-react';
---

<div class="relative z-50" id="theme-picker-container">
  <!-- è§¦å‘æŒ‰é’® -->
  <button 
    id="theme-btn"
    class="p-2.5 bg-white/80 dark:bg-gray-800/80 backdrop-blur-md rounded-xl text-slate-500 hover:text-brand-600 hover:bg-slate-100 dark:hover:bg-gray-700 transition-all shadow-sm border border-slate-200/50 dark:border-gray-700/50"
    title="å¤–è§‚è®¾ç½®"
  >
    <Palette size={20} />
  </button>

  <!-- è®¾ç½®é¢æ¿ -->
  <!-- 
     ä¿®å¤ï¼šæŠŠ h- æ”¹ä¸º max-h- å’Œ h-autoï¼Œé˜²æ­¢å†…å®¹å°‘æ—¶ç•™ç™½
  -->
  <div 
    id="theme-panel"
    class="absolute right-0 top-14 w-72 bg-white/95 dark:bg-gray-900/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-white/50 dark:border-gray-700/50 p-4 transform transition-all duration-200 origin-top-right scale-95 opacity-0 invisible select-none max-h-[calc(100vh-100px)] h-auto overflow-y-auto custom-scrollbar"
  >
    <!-- 1. ä¸»é¢˜æ¨¡å¼ -->
    <div class="flex items-center justify-between mb-4">
      <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">æ¨¡å¼</span>
      <div class="flex bg-slate-100 dark:bg-gray-800 p-1 rounded-lg">
        <button class="mode-btn p-1.5 rounded-md transition-all text-slate-500 hover:text-brand-600" data-mode="light" title="æµ…è‰²"><Sun size={14} /></button>
        <button class="mode-btn p-1.5 rounded-md transition-all text-slate-500 hover:text-brand-600" data-mode="dark" title="æ·±è‰²"><Moon size={14} /></button>
        <button class="mode-btn p-1.5 rounded-md transition-all text-slate-500 hover:text-brand-600" data-mode="auto" title="è·Ÿéšç³»ç»Ÿ"><Monitor size={14} /></button>
      </div>
    </div>

    <!-- 2. ä¸»é¢˜è‰²å½© -->
    <div class="mb-4">
      <div class="flex items-center justify-between mb-2">
        <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">è‰²å½©</span>
        <div class="flex items-center gap-2 bg-slate-100 dark:bg-gray-800 rounded-lg p-1 pr-2 border border-slate-200 dark:border-gray-700">
           <input type="color" id="custom-color-picker" class="w-5 h-5 rounded cursor-pointer border-0 p-0 bg-transparent" />
           <input type="text" id="hex-input" class="w-14 bg-transparent text-[10px] font-mono text-slate-600 dark:text-slate-300 outline-none uppercase" placeholder="#HEX" maxlength="7" />
        </div>
      </div>
      <div class="flex flex-wrap gap-2 mb-2" id="preset-colors"></div>
    </div>

    <hr class="border-slate-100 dark:border-gray-700/50 my-3" />

    <!-- 3. åŠ¨ç”»æ’ä»¶ (æ–°å¢ï¼Œæ›¿ä»£åŸå­—ä½“ä½ç½®) -->
    <div class="mb-4">
      <div class="flex items-center justify-between mb-2">
        <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">åŠ¨æ•ˆé£æ ¼</span>
      </div>
      <div class="grid grid-cols-3 gap-2">
        <button class="anim-btn px-2 py-1.5 rounded-lg border border-slate-200 dark:border-gray-700 text-[10px] text-center hover:border-brand-500 transition-all" data-anim="none">æ— </button>
        <button class="anim-btn px-2 py-1.5 rounded-lg border border-slate-200 dark:border-gray-700 text-[10px] text-center hover:border-brand-500 transition-all" data-anim="fade-up">ä¸Šæµ®</button>
        <button class="anim-btn px-2 py-1.5 rounded-lg border border-slate-200 dark:border-gray-700 text-[10px] text-center hover:border-brand-500 transition-all" data-anim="wave">æ³¢æµª</button>
      </div>
    </div>

    <hr class="border-slate-100 dark:border-gray-700/50 my-3" />

    <!-- 4. èƒŒæ™¯è®¾ç½® -->
    <div class="mb-4">
      <div class="flex items-center justify-between mb-2">
        <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">èƒŒæ™¯å£çº¸</span>
        <label for="bg-upload" class="cursor-pointer text-[10px] bg-slate-100 dark:bg-gray-800 hover:bg-brand-50 text-brand-600 px-2 py-1 rounded-md transition-colors flex items-center gap-1 border border-slate-200 dark:border-gray-700">
          <Upload size={10} /> ä¸Šä¼ 
        </label>
        <input type="file" id="bg-upload" accept="image/*" class="hidden" />
      </div>

      <div id="bg-preview-area" class="hidden relative w-full h-24 rounded-lg overflow-hidden border border-slate-200 dark:border-gray-700 mb-3 group bg-slate-100 dark:bg-gray-800">
        <img id="bg-preview-img" class="w-full h-full object-cover" />
        <button id="bg-remove-btn" class="absolute top-1 right-1 p-1 bg-black/50 text-white rounded-full hover:bg-red-500 transition-colors opacity-0 group-hover:opacity-100" title="ç§»é™¤">
          <X size={12} />
        </button>
      </div>

      <div class="flex items-center justify-between gap-3">
        <span class="text-[10px] font-medium text-slate-500 shrink-0">æ¨¡ç³Š</span>
        <input type="range" id="blur-range" min="0" max="50" step="1" class="w-full h-1.5 bg-slate-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer accent-brand-600" />
        <span id="blur-val" class="text-[10px] font-mono text-slate-400 w-6 text-right">0px</span>
      </div>
    </div>

    <hr class="border-slate-100 dark:border-gray-700/50 my-3" />

    <!-- 5. æ•°æ®å¤‡ä»½ -->
    <div class="mb-2">
      <div class="flex items-center justify-between mb-2">
        <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">é…ç½®å¤‡ä»½</span>
      </div>
      <div class="grid grid-cols-2 gap-2">
        <button id="export-btn" class="px-3 py-2 rounded-lg border border-slate-200 dark:border-gray-700 text-xs text-slate-600 dark:text-slate-300 hover:border-brand-500 hover:text-brand-600 transition-all flex items-center justify-center gap-1">
          <Download size={12} /> å¯¼å‡º
        </button>
        <label class="px-3 py-2 rounded-lg border border-slate-200 dark:border-gray-700 text-xs text-slate-600 dark:text-slate-300 hover:border-brand-500 hover:text-brand-600 transition-all flex items-center justify-center gap-1 cursor-pointer">
          <Upload size={12} /> å¯¼å…¥
          <input type="file" id="import-config" accept=".json" class="hidden" />
        </label>
      </div>
    </div>
  </div>
</div>

<!-- 
  ğŸ”¥ å¤´éƒ¨é˜»å¡è„šæœ¬ï¼šè´Ÿè´£ç«‹å³æ¢å¤çŠ¶æ€ (æ— å­—ä½“é€»è¾‘)
-->
<script is:inline>
(function() {
  // 1. æ¢å¤é¢œè‰²
  const savedColor = localStorage.getItem('brand-color') || '#4F46E5';
  const r = parseInt(savedColor.slice(1, 3), 16);
  const g = parseInt(savedColor.slice(3, 5), 16);
  const b = parseInt(savedColor.slice(5, 7), 16);
  document.documentElement.style.setProperty('--color-brand-rgb', `${r} ${g} ${b}`);

  // 2. æ¢å¤ä¸»é¢˜ (Light/Dark)
  const savedTheme = localStorage.getItem('theme') || 'auto';
  const root = document.documentElement;
  if (savedTheme === 'auto') {
    if (window.matchMedia('(prefers-color-scheme: dark)').matches) root.classList.add('dark');
    else root.classList.remove('dark');
  } else {
    root.classList.toggle('dark', savedTheme === 'dark');
  }

  // 3. æ¢å¤æ¨¡ç³Š
  const savedBlur = localStorage.getItem('bg-blur') || 0;
  document.documentElement.style.setProperty('--bg-blur', `${savedBlur}px`);

  // 4. æ¢å¤åŠ¨ç”»æ’ä»¶ (æ–°å¢)
  const savedAnim = localStorage.getItem('site-anim') || 'fade-up';
  document.documentElement.setAttribute('data-anim', savedAnim);
})();
</script>

<!-- 
  åº•éƒ¨äº¤äº’è„šæœ¬ï¼šè´Ÿè´£ UI ç»‘å®šå’Œäº‹ä»¶å¤„ç† (æ— å­—ä½“é€»è¾‘)
-->
<script is:inline>
(function() {
  // === IndexedDB å·¥å…· ===
  const DB_NAME = 'MyNavDB';
  const STORE_NAME = 'settings';
  let dbPromise = null;

  function getDB() {
    if (!dbPromise) {
      dbPromise = new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, 1);
        request.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME);
        };
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }
    return dbPromise;
  }
  async function saveImage(blob) { const db = await getDB(); const tx = db.transaction(STORE_NAME, 'readwrite'); tx.objectStore(STORE_NAME).put(blob, 'bg-image'); }
  async function getImage() { const db = await getDB(); return new Promise(r => { const tx = db.transaction(STORE_NAME, 'readonly'); tx.objectStore(STORE_NAME).get('bg-image').onsuccess = e => r(e.target.result); }); }
  async function removeImage() { const db = await getDB(); const tx = db.transaction(STORE_NAME, 'readwrite'); tx.objectStore(STORE_NAME).delete('bg-image'); }

  // === ç‹¬ç«‹æ‰§è¡Œï¼šå¼‚æ­¥åŠ è½½èƒŒæ™¯å›¾ ===
  (async function loadBg() {
    try {
      const blob = await getImage();
      if (blob) {
        const url = URL.createObjectURL(blob);
        const current = document.documentElement.style.getPropertyValue('--bg-image');
        if (!current || current === 'none') {
            document.documentElement.style.setProperty('--bg-image', `url(${url})`);
        }
        const area = document.getElementById('bg-preview-area');
        const img = document.getElementById('bg-preview-img');
        if (area && img) { area.classList.remove('hidden'); img.src = url; }
      }
    } catch(e) {}
  })();

  // === åˆå§‹åŒ–äº¤äº’é€»è¾‘ ===
  function initThemePicker() {
    const container = document.getElementById('theme-picker-container');
    const btn = document.getElementById('theme-btn');
    const panel = document.getElementById('theme-panel');
    if (!btn || !panel) return;

    // --- é¢æ¿å¼€å…³ ---
    let isPanelOpen = false;
    function togglePanel(forceState) {
      isPanelOpen = forceState !== undefined ? forceState : !isPanelOpen;
      panel.classList.toggle('invisible', !isPanelOpen);
      panel.classList.toggle('opacity-0', !isPanelOpen);
      panel.classList.toggle('scale-95', !isPanelOpen);
      panel.classList.toggle('visible', isPanelOpen);
      panel.classList.toggle('opacity-100', isPanelOpen);
      panel.classList.toggle('scale-100', isPanelOpen);
    }
    btn.onclick = (e) => { e.stopPropagation(); togglePanel(); };
    const closeHandler = (e) => { if (isPanelOpen && !container.contains(e.target)) togglePanel(false); };
    document.removeEventListener('click', closeHandler);
    document.addEventListener('click', closeHandler);

    // --- é¢œè‰²è®¾ç½® ---
    const colorPicker = document.getElementById('custom-color-picker');
    const hexInput = document.getElementById('hex-input');
    const savedColor = localStorage.getItem('brand-color') || '#4F46E5';
    if(colorPicker) colorPicker.value = savedColor;
    if(hexInput) hexInput.value = savedColor;

    function hexToRgb(hex) { const r = parseInt(hex.slice(1, 3), 16); const g = parseInt(hex.slice(3, 5), 16); const b = parseInt(hex.slice(5, 7), 16); return `${r} ${g} ${b}`; }
    function setBrandColor(hex) {
      if (!/^#[0-9A-F]{6}$/i.test(hex)) return;
      const rgb = hexToRgb(hex);
      document.documentElement.style.setProperty('--color-brand-rgb', rgb);
      localStorage.setItem('brand-color', hex);
      if(colorPicker) colorPicker.value = hex;
      if(hexInput) hexInput.value = hex;
      updatePresetUI(hex);
    }
    
    function updatePresetUI(hex) {
      document.querySelectorAll('.preset-color-btn').forEach(btn => {
        btn.innerHTML = btn.dataset.color.toLowerCase() === hex.toLowerCase() ? 'âœ”' : '';
        btn.style.color = 'white'; btn.style.fontWeight = 'bold';
      });
    }
    
    if(colorPicker) colorPicker.oninput = e => setBrandColor(e.target.value);
    if(hexInput) hexInput.oninput = e => { let v=e.target.value; if(!v.startsWith('#')) v='#'+v; if(v.length===7) setBrandColor(v); };

    // é¢„è®¾é¢œè‰²æŒ‰é’®
    const presets = ['#4F46E5', '#DB2777', '#7C3AED', '#2563EB', '#059669', '#DC2626', '#D97706', '#000000'];
    const presetContainer = document.getElementById('preset-colors');
    if (presetContainer && presetContainer.children.length === 0) {
        presets.forEach(color => {
            const b = document.createElement('button');
            b.className = 'preset-color-btn w-6 h-6 rounded-full flex items-center justify-center transition-transform hover:scale-110 border border-black/10 text-[10px]';
            b.style.backgroundColor = color;
            b.dataset.color = color;
            b.onclick = () => setBrandColor(color);
            presetContainer.appendChild(b);
        });
        updatePresetUI(savedColor);
    }

    // --- åŠ¨ç”»åˆ‡æ¢é€»è¾‘ (æ–°å¢) ---
    const animBtns = document.querySelectorAll('.anim-btn');
    const updateAnimBtns = (name) => {
        animBtns.forEach(b => {
            const active = b.dataset.anim === name;
            b.classList.toggle('bg-brand-50', active);
            b.classList.toggle('text-brand-600', active);
            b.classList.toggle('border-brand-500', active);
            b.classList.toggle('dark:bg-brand-900/20', active);
            b.classList.toggle('border-slate-200', !active);
            b.classList.toggle('dark:border-gray-700', !active);
        });
    }
    const currentAnim = localStorage.getItem('site-anim') || 'fade-up';
    updateAnimBtns(currentAnim);

    function setAnim(name) {
      document.documentElement.setAttribute('data-anim', name);
      localStorage.setItem('site-anim', name);
      updateAnimBtns(name);
    }
    animBtns.forEach(b => b.onclick = () => setAnim(b.dataset.anim));


    // --- æ¨¡å¼åˆ‡æ¢ ---
    const modeBtns = document.querySelectorAll('.mode-btn');
    function updateModeUI(t) {
        modeBtns.forEach(b => {
            const active = b.dataset.mode === t;
            b.classList.toggle('bg-white', active);
            b.classList.toggle('dark:bg-gray-600', active);
            b.classList.toggle('text-brand-600', active);
            b.classList.toggle('text-slate-500', !active);
        });
    }
    const savedTheme = localStorage.getItem('theme') || 'auto';
    updateModeUI(savedTheme);
    
    function setTheme(t) {
      const root = document.documentElement;
      if (t === 'auto') {
          localStorage.removeItem('theme');
          if (window.matchMedia('(prefers-color-scheme: dark)').matches) root.classList.add('dark'); else root.classList.remove('dark');
      } else {
          root.classList.toggle('dark', t === 'dark');
          localStorage.setItem('theme', t);
      }
      updateModeUI(t);
    }
    modeBtns.forEach(b => b.onclick = () => setTheme(b.dataset.mode));

    // --- æ¨¡ç³Šä¸èƒŒæ™¯ ---
    const blurRange = document.getElementById('blur-range');
    const blurVal = document.getElementById('blur-val');
    const savedBlur = localStorage.getItem('bg-blur') || 0;
    if(blurRange) blurRange.value = savedBlur;
    if(blurVal) blurVal.textContent = `${savedBlur}px`;

    function setBlur(px) {
      document.documentElement.style.setProperty('--bg-blur', `${px}px`);
      if(blurVal) blurVal.textContent = `${px}px`;
      localStorage.setItem('bg-blur', px);
    }
    if(blurRange) blurRange.oninput = (e) => setBlur(e.target.value);

    // èƒŒæ™¯ä¸Šä¼ é€»è¾‘
    const bgUpload = document.getElementById('bg-upload');
    const bgPreviewArea = document.getElementById('bg-preview-area');
    const bgPreviewImg = document.getElementById('bg-preview-img');
    const bgRemoveBtn = document.getElementById('bg-remove-btn');

    const currentBg = getComputedStyle(document.documentElement).getPropertyValue('--bg-image').trim();
    if(currentBg && currentBg !== 'none') {
        const url = currentBg.slice(4, -1).replace(/["']/g, ""); 
        if(bgPreviewArea) bgPreviewArea.classList.remove('hidden');
        if(bgPreviewImg) bgPreviewImg.src = url;
    }

    if(bgUpload) {
        bgUpload.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const url = URL.createObjectURL(file);
            document.documentElement.style.setProperty('--bg-image', `url(${url})`);
            if(bgPreviewArea) bgPreviewArea.classList.remove('hidden');
            if(bgPreviewImg) bgPreviewImg.src = url;
            try { await saveImage(file); } catch (err) {}
        };
    }
    if(bgRemoveBtn) {
        bgRemoveBtn.onclick = async () => {
            document.documentElement.style.setProperty('--bg-image', 'none');
            if(bgPreviewArea) bgPreviewArea.classList.add('hidden');
            await removeImage();
            if(bgUpload) bgUpload.value = '';
        };
    }
    
    // --- å¯¼å…¥å¯¼å‡ºé€»è¾‘ ---
    const blobToBase64 = (blob) => new Promise((r, j) => { const reader = new FileReader(); reader.onloadend = () => r(reader.result); reader.onerror = j; reader.readAsDataURL(blob); });
    const base64ToBlob = async (base64) => (await fetch(base64)).blob();

    const exportBtn = document.getElementById('export-btn');
    if (exportBtn) {
      exportBtn.onclick = async () => {
        const config = {
          theme: localStorage.getItem('theme'),
          brandColor: localStorage.getItem('brand-color'),
          bgBlur: localStorage.getItem('bg-blur'),
          siteAnim: localStorage.getItem('site-anim'), // å¯¼å‡ºåŠ¨ç”»è®¾ç½®
          bgImage: null
        };
        try {
          const blob = await getImage();
          if (blob) config.bgImage = await blobToBase64(blob);
          const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(config));
          const dlNode = document.createElement('a');
          dlNode.setAttribute("href", dataStr);
          dlNode.setAttribute("download", "my-nav-config.json");
          document.body.appendChild(dlNode);
          dlNode.click();
          dlNode.remove();
        } catch (e) { alert('å¯¼å‡ºå¤±è´¥'); }
      };
    }

    const importInput = document.getElementById('import-config');
    if (importInput) {
      importInput.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (event) => {
          try {
            const config = JSON.parse(event.target.result);
            if (config.theme) localStorage.setItem('theme', config.theme);
            if (config.brandColor) localStorage.setItem('brand-color', config.brandColor);
            if (config.bgBlur) localStorage.setItem('bg-blur', config.bgBlur);
            if (config.siteAnim) localStorage.setItem('site-anim', config.siteAnim); // å¯¼å…¥åŠ¨ç”»è®¾ç½®

            if (config.bgImage) { await saveImage(await base64ToBlob(config.bgImage)); } else { await removeImage(); }
            alert('å¯¼å…¥æˆåŠŸï¼Œå³å°†åˆ·æ–°');
            location.reload();
          } catch (err) { alert('æ–‡ä»¶æ ¼å¼é”™è¯¯'); }
        };
        reader.readAsText(file);
      };
    }
  }

  // ç«‹å³æ‰§è¡Œä¸€æ¬¡åˆå§‹åŒ–
  initThemePicker();

  // ç»‘å®š Astro é¡µé¢åˆ‡æ¢äº‹ä»¶
  document.addEventListener('astro:after-swap', initThemePicker);
})();
</script>

<style>
  input[type=range] { accent-color: rgb(var(--color-brand-rgb)); }
  .custom-scrollbar::-webkit-scrollbar { width: 4px; }
  .custom-scrollbar::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.5); border-radius: 4px; }
</style>