---
import { Palette, Sun, Moon, Monitor, Upload, X, Check } from 'lucide-react';
---

<div class="relative z-50" id="theme-picker-container">
  <!-- 触发按钮 -->
  <button 
    id="theme-btn"
    class="p-2.5 bg-white/80 dark:bg-gray-800/80 backdrop-blur-md rounded-xl text-slate-500 hover:text-brand-600 hover:bg-slate-100 dark:hover:bg-gray-700 transition-all shadow-sm border border-slate-200/50 dark:border-gray-700/50"
    title="主题设置"
  >
    <Palette size={20} />
  </button>

  <!-- 设置面板 -->
  <div 
    id="theme-panel"
    class="absolute right-0 top-14 w-72 bg-white/95 dark:bg-gray-900/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-white/50 dark:border-gray-700/50 p-4 transform transition-all duration-200 origin-top-right scale-95 opacity-0 invisible select-none"
  >
    <!-- 1. 主题模式 -->
    <div class="flex items-center justify-between mb-4">
      <span class="text-sm font-bold text-slate-700 dark:text-slate-200 border-l-4 border-brand-600 pl-2">主题模式</span>
      <div class="flex bg-slate-100 dark:bg-gray-800 p-1 rounded-lg">
        <button class="mode-btn p-1.5 rounded-md transition-all text-slate-500 hover:text-brand-600" data-mode="light" title="浅色"><Sun size={16} /></button>
        <button class="mode-btn p-1.5 rounded-md transition-all text-slate-500 hover:text-brand-600" data-mode="dark" title="深色"><Moon size={16} /></button>
        <button class="mode-btn p-1.5 rounded-md transition-all text-slate-500 hover:text-brand-600" data-mode="auto" title="跟随系统"><Monitor size={16} /></button>
      </div>
    </div>

    <!-- 2. 主题色彩 (自定义输入) -->
    <div class="mb-4">
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm font-bold text-slate-700 dark:text-slate-200 border-l-4 border-brand-600 pl-2">主题色彩</span>
        
        <!-- 颜色选择器 + Hex 输入框 -->
        <div class="flex items-center gap-2 bg-slate-100 dark:bg-gray-800 rounded-lg p-1 pr-2 border border-slate-200 dark:border-gray-700">
           <input type="color" id="custom-color-picker" class="w-6 h-6 rounded cursor-pointer border-0 p-0 bg-transparent" />
           <input type="text" id="hex-input" class="w-16 bg-transparent text-xs font-mono text-slate-600 dark:text-slate-300 outline-none uppercase" placeholder="#HEX" maxlength="7" />
        </div>
      </div>
      
      <!-- 预设颜色 -->
      <div class="flex flex-wrap gap-2 mb-2" id="preset-colors"></div>
    </div>

    <hr class="border-slate-100 dark:border-gray-700/50 my-3" />

    <!-- 3. 背景设置 (IndexedDB 无大小限制) -->
    <div class="mb-4">
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm font-bold text-slate-700 dark:text-slate-200 border-l-4 border-brand-600 pl-2">背景图片</span>
        <label for="bg-upload" class="cursor-pointer text-xs bg-slate-100 dark:bg-gray-800 hover:bg-brand-50 text-brand-600 px-2 py-1 rounded-md transition-colors flex items-center gap-1 border border-slate-200 dark:border-gray-700">
          <Upload size={12} /> 上传
        </label>
        <input type="file" id="bg-upload" accept="image/*" class="hidden" />
      </div>

      <!-- 图片预览 -->
      <div id="bg-preview-area" class="hidden relative w-full h-24 rounded-lg overflow-hidden border border-slate-200 dark:border-gray-700 mb-3 group bg-slate-100 dark:bg-gray-800">
        <img id="bg-preview-img" class="w-full h-full object-cover" />
        <button id="bg-remove-btn" class="absolute top-1 right-1 p-1 bg-black/50 text-white rounded-full hover:bg-red-500 transition-colors opacity-0 group-hover:opacity-100" title="移除背景">
          <X size={14} />
        </button>
      </div>

      <!-- 模糊调节 -->
      <div class="flex items-center justify-between gap-3">
        <span class="text-xs font-medium text-slate-500 shrink-0">模糊度</span>
        <input type="range" id="blur-range" min="0" max="50" step="1" class="w-full h-1.5 bg-slate-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer accent-brand-600" />
        <span id="blur-val" class="text-xs font-mono text-slate-400 w-6 text-right">0px</span>
      </div>
    </div>
  </div>
</div>

<script is:inline>
  // =======================================================
  // 1. 全局工具函数 (这些不需要每次页面切换都重置，放在外面)
  // =======================================================
  
  // IndexedDB 工具
  const DB_NAME = 'MyNavDB';
  const STORE_NAME = 'settings';
  let dbPromise = null;

  function getDB() {
    if (!dbPromise) {
      dbPromise = new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, 1);
        request.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME);
        };
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }
    return dbPromise;
  }

  async function saveImage(blob) {
    const db = await getDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE_NAME, 'readwrite');
      tx.objectStore(STORE_NAME).put(blob, 'bg-image');
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  }

  async function getImage() {
    const db = await getDB();
    return new Promise((resolve) => {
      const tx = db.transaction(STORE_NAME, 'readonly');
      const req = tx.objectStore(STORE_NAME).get('bg-image');
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => resolve(null);
    });
  }

  async function removeImage() {
    const db = await getDB();
    const tx = db.transaction(STORE_NAME, 'readwrite');
    tx.objectStore(STORE_NAME).delete('bg-image');
  }

  // 辅助函数：Hex 转 RGB
  function hexToRgb(hex) {
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    return `${r} ${g} ${b}`;
  }

  // =======================================================
  // 2. 初始化逻辑 (核心修复：封装成函数，每次页面加载都跑)
  // =======================================================
  function initThemePicker() {
    console.log('[ThemePicker] Initializing...'); // 调试日志

    const container = document.getElementById('theme-picker-container');
    const btn = document.getElementById('theme-btn');
    const panel = document.getElementById('theme-panel');
    
    // 如果当前页面没有这个组件（虽然理论上都有），直接退出
    if (!btn || !panel) return;

    // --- A. 面板交互 ---
    let isPanelOpen = false;

    function togglePanel(forceState) {
      isPanelOpen = forceState !== undefined ? forceState : !isPanelOpen;
      if (isPanelOpen) {
        panel.classList.remove('invisible', 'opacity-0', 'scale-95');
        panel.classList.add('visible', 'opacity-100', 'scale-100');
      } else {
        panel.classList.remove('visible', 'opacity-100', 'scale-100');
        panel.classList.add('invisible', 'opacity-0', 'scale-95');
      }
    }

    // 解绑旧事件（防止多次绑定），虽然 astro:page-load 通常意味着全新 DOM，但为了保险
    // 更好的方式是直接绑定，因为 DOM 是新的
    btn.onclick = (e) => {
      e.stopPropagation();
      togglePanel();
    };

    // 全局点击关闭
    const closeHandler = (e) => {
      if (isPanelOpen && container && !container.contains(e.target)) {
        togglePanel(false);
      }
    };
    document.removeEventListener('click', closeHandler); // 先移除旧的
    document.addEventListener('click', closeHandler);


    // --- B. 颜色逻辑 ---
    const colorPicker = document.getElementById('custom-color-picker');
    const hexInput = document.getElementById('hex-input');
    
    function setBrandColor(hex) {
      if (!/^#[0-9A-F]{6}$/i.test(hex)) return;
      
      const rgb = hexToRgb(hex);
      document.documentElement.style.setProperty('--color-brand-rgb', rgb);
      localStorage.setItem('brand-color', hex);
      
      if(colorPicker) colorPicker.value = hex;
      if(hexInput) hexInput.value = hex;
      
      document.querySelectorAll('.preset-color-btn').forEach(btn => {
        btn.innerHTML = '';
        if (btn.dataset.color.toLowerCase() === hex.toLowerCase()) {
          btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="text-white"><polyline points="20 6 9 17 4 12"></polyline></svg>';
        }
      });
    }

    if(colorPicker) colorPicker.oninput = (e) => setBrandColor(e.target.value);
    if(hexInput) hexInput.oninput = (e) => {
      let val = e.target.value;
      if (!val.startsWith('#')) val = '#' + val;
      if (val.length === 7) setBrandColor(val);
    };

    // 生成预设
    const presets = ['#4F46E5', '#DB2777', '#7C3AED', '#2563EB', '#059669', '#DC2626', '#D97706', '#000000'];
    const presetContainer = document.getElementById('preset-colors');
    if (presetContainer && presetContainer.children.length === 0) {
        presets.forEach(color => {
            const b = document.createElement('button');
            b.className = 'preset-color-btn w-6 h-6 rounded-full flex items-center justify-center transition-transform hover:scale-110 border border-black/10';
            b.style.backgroundColor = color;
            b.dataset.color = color;
            b.onclick = () => setBrandColor(color);
            presetContainer.appendChild(b);
        });
    }

    // --- C. 背景图逻辑 ---
    const bgUpload = document.getElementById('bg-upload');
    const bgPreviewArea = document.getElementById('bg-preview-area');
    const bgPreviewImg = document.getElementById('bg-preview-img');
    const bgRemoveBtn = document.getElementById('bg-remove-btn');

    function applyBackground(url) {
      if (url) {
        document.documentElement.style.setProperty('--bg-image', `url(${url})`);
        if(bgPreviewArea) bgPreviewArea.classList.remove('hidden');
        if(bgPreviewImg) bgPreviewImg.src = url;
      } else {
        document.documentElement.style.setProperty('--bg-image', 'none');
        if(bgPreviewArea) bgPreviewArea.classList.add('hidden');
      }
    }

    if(bgUpload) {
        bgUpload.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const url = URL.createObjectURL(file);
            applyBackground(url);
            try { await saveImage(file); } catch (err) { console.error(err); }
        };
    }

    if(bgRemoveBtn) {
        bgRemoveBtn.onclick = async () => {
            applyBackground(null);
            await removeImage();
            if(bgUpload) bgUpload.value = '';
        };
    }

    // --- D. 模糊与主题 ---
    const blurRange = document.getElementById('blur-range');
    const blurVal = document.getElementById('blur-val');
    
    function setBlur(px) {
      document.documentElement.style.setProperty('--bg-blur', `${px}px`);
      if(blurVal) blurVal.textContent = `${px}px`;
      localStorage.setItem('bg-blur', px);
    }
    if(blurRange) blurRange.oninput = (e) => setBlur(e.target.value);

    const modeBtns = document.querySelectorAll('.mode-btn');
    function setTheme(t) {
      const root = document.documentElement;
      if (t === 'auto') {
          localStorage.removeItem('theme');
          if (window.matchMedia('(prefers-color-scheme: dark)').matches) root.classList.add('dark');
          else root.classList.remove('dark');
      } else {
          root.classList.toggle('dark', t === 'dark');
          localStorage.setItem('theme', t);
      }
      modeBtns.forEach(b => {
          const active = b.dataset.mode === t;
          b.classList.toggle('bg-white', active);
          b.classList.toggle('dark:bg-gray-600', active);
          b.classList.toggle('text-brand-600', active);
          b.classList.toggle('text-slate-500', !active);
      });
    }
    modeBtns.forEach(b => b.onclick = () => setTheme(b.dataset.mode));

    // --- E. 恢复状态 ---
    const savedColor = localStorage.getItem('brand-color') || '#4F46E5';
    setBrandColor(savedColor);

    const savedTheme = localStorage.getItem('theme') || 'auto';
    setTheme(savedTheme);

    const savedBlur = localStorage.getItem('bg-blur') || 0;
    if(blurRange) blurRange.value = savedBlur;
    setBlur(savedBlur);

    // 每次页面加载都尝试读取背景图
    getImage().then(blob => {
      if (blob) applyBackground(URL.createObjectURL(blob));
    });
  }

  // =======================================================
  // 3. 绑定生命周期 (关键！)
  // =======================================================
  
  // 监听 astro:page-load，它在【首次加载】和【页面切换后】都会触发
  document.addEventListener('astro:page-load', initThemePicker);

</script>


<style>
  input[type=range] { accent-color: rgb(var(--color-brand-rgb)); }
</style>