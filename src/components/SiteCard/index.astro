---
// src/components/SiteCard/index.astro
import { BookOpen, Info } from 'lucide-react';
// å¼•å…¥ Astro å›¾ç‰‡ç»„ä»¶
import { Image } from 'astro:assets';
// å¼•å…¥ Keystatic æ–‡æ¡£æ¸²æŸ“å™¨
import { DocumentRenderer } from '@keystatic/core/renderer';
import { getIconSources, getBadges } from './utils';

// å¼•å…¥æ ·å¼
import './site-card.css';

// æ¥æ”¶ Props
const { title, name, url, icon, desc, detail, official_site, hide_badges = [], guide_id } = Astro.props;

const targetUrl = url || official_site || '#';

const displayTitle = title || name;
const base = import.meta.env.BASE_URL.replace(/\/$/, '');

// 1. å›¾æ ‡é€»è¾‘
const { sources: iconSources, domain, localFallback } = getIconSources({ icon, url, official_site, base });
// ç­–ç•¥ï¼šå¦‚æœ icon å±æ€§å­˜åœ¨ä¸”åŒ…å« "/images/"ï¼Œè¯´æ˜æ˜¯æœ¬åœ°ä¼˜åŒ–è¿‡çš„å›¾ï¼Œç›´æ¥ç”¨ã€‚
const finalIcon = (icon && icon.includes('/images/')) ? icon : (iconSources.custom || iconSources.level1 || localFallback);

// 2. å¾½ç« é€»è¾‘
const badges = getBadges(url, hide_badges);

// 3. è¯¦æƒ…å†…å®¹é€»è¾‘ (ä¿®å¤ç‚¹)
// detail ç°åœ¨æ˜¯ JSON æ•°ç»„ (Keystatic Document)ï¼Œä¸å†æ˜¯ Markdown å­—ç¬¦ä¸²
const hasDetailContent = Array.isArray(detail) && detail.length > 0;

// ğŸ”¥ è®¡ç®— hasPopup (åªå®šä¹‰è¿™ä¸€æ¬¡)
const hasPopup = !!(hasDetailContent || (badges && badges.length > 0));

const cardId = `site-${domain ? domain.replace(/[^a-zA-Z0-9]/g, '-') : Math.random().toString(36).substr(2, 9)}`;

// å®šä¹‰å›¾æ ‡å°ºå¯¸
const ICON_SIZE = 48;
---

<div class="site-card-wrapper group relative w-full h-full">
  <a href={targetUrl} target="_blank" 
     class="flex items-center justify-between w-full h-full py-3 pl-3 pr-2
            bg-white/70 dark:bg-gray-800/60 backdrop-blur-xl rounded-xl 
            border border-white/60 dark:border-gray-700/50 
            transition-all duration-300 ease-[cubic-bezier(0.25,0.8,0.25,1)]
            hover:-translate-y-1.5 
            hover:bg-white/95 dark:hover:bg-gray-800/95
            hover:border-brand-500/30 dark:hover:border-brand-400/30
            hover:shadow-xl hover:shadow-brand-600/10 
            hover:ring-1 hover:ring-brand-500/20
            relative overflow-hidden"
  >
    <div class="flex items-center flex-1 min-w-0 mr-1">
        <div class="relative flex-shrink-0 mr-3 w-10 h-10 flex items-center justify-center">
          {/* èƒŒæ™¯å…‰æ™•å±‚ */}
          <div class="absolute inset-0 z-0 transition-all duration-500 ease-out opacity-0 group-hover:opacity-50 group-hover:scale-150 filter blur-lg saturate-150 pointer-events-none transform-gpu">
             <Image 
                src={finalIcon} 
                alt="" 
                width={ICON_SIZE} 
                height={ICON_SIZE} 
                class="w-full h-full object-contain" 
             />
          </div>
          
          {/* æ ¸å¿ƒå›¾æ ‡å±‚ */}
          <div class="relative z-10 w-10 h-10 rounded-lg bg-white/80 dark:bg-gray-700/90 shadow-sm flex items-center justify-center border 
               border-gray-100 dark:border-gray-600 group-hover:scale-105 group-hover:shadow-md transition-all duration-300">
            <Image 
              id={cardId}
              src={finalIcon}
              alt={displayTitle} 
              width={ICON_SIZE} 
              height={ICON_SIZE}
              loading="lazy" 
              class="w-6 h-6 object-contain transition-transform duration-300" 
              data-domain={domain}
              data-sources={JSON.stringify(iconSources)}
              onerror={`this.onerror=null; this.src='${localFallback}';`}
            />
          </div>
        </div>
        
        <div class="flex-1 min-w-0 relative z-20">
          <h3 class="font-heading font-bold text-[14px] text-slate-800 dark:text-slate-100 truncate mb-0.5 text-left group-hover:text-brand-600 transition-colors duration-200">
            {displayTitle}
          </h3>
          {desc && (
            <p class="font-body text-[12px] text-slate-400 dark:text-slate-500 leading-tight line-clamp-1 overflow-hidden text-left break-words opacity-80 group-hover:opacity-100 transition-opacity">
              {desc}
            </p>
          )}
        </div>
    </div>

    {/* å³ä¾§æŒ‰é’®åŒºåŸŸ */}
    <div class="flex flex-col gap-1 shrink-0 pl-1 border-l border-slate-100 dark:border-slate-700/50 
                 transition-all duration-200 z-20
                 opacity-100 translate-x-0
                 md:opacity-0 md:-translate-x-2 
                 md:group-hover:opacity-100 md:group-hover:translate-x-0">
        {hasPopup && (
          <button type="button" class="info-btn md:hidden p-1 rounded-md text-slate-400 hover:text-brand-600 hover:bg-brand-50 dark:hover:bg-gray-700 transition-all flex items-center justify-center" title="è¯¦æƒ…">
            <Info size={14} />
          </button>
        )}
        {guide_id && (
          <button onclick={`event.preventDefault(); event.stopPropagation(); window.open('${base}/guide/${guide_id}', '_blank');`} class="p-1 rounded-md text-brand-400 hover:bg-brand-600 hover:text-white transition-all flex items-center justify-center" title="æ•™ç¨‹">
            <BookOpen size={14} strokeWidth={2.5} />
          </button>
        )}
    </div>
  </a>

  {/* å¼¹çª—åŒºåŸŸ */}
  {hasPopup && (
    <div class="tooltip-source hidden">
      <div class="relative z-10">
        <div class="text-[11px] font-black text-brand-600 dark:text-brand-400 mb-2 flex items-center gap-2 uppercase tracking-widest font-body">
          <span class="w-1.5 h-3 bg-brand-600 rounded-sm"></span>è¯¦æƒ…
        </div>
        {badges.length > 0 && (
          <div class="flex flex-wrap gap-2 mb-2 border-b border-slate-100 dark:border-slate-800 pb-2">
            {badges.map(b => <img src={b.src} alt={b.alt} class="h-4 rounded-sm" />)}
          </div>
        )}
        
        {/* ä½¿ç”¨ DocumentRenderer æ¸²æŸ“ JSON æ•°æ® */}
        {hasDetailContent && (
          <div class="detail-markdown font-body text-[13px] text-slate-700 dark:text-slate-300 leading-relaxed break-words">
             <DocumentRenderer document={detail} />
          </div>
        )}
      </div>
    </div>
  )}
</div>

<script>
  import { initSiteCard } from './client';
  
  document.addEventListener('astro:page-load', initSiteCard);
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSiteCard);
  } else {
    initSiteCard();
  }
</script>